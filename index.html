<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calcule Taxas By Brendon</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    / GARANTINDO QUE HTML E BODY OCUPEM A TELA INTEIRA SEM MARGENS/PADDINGS /
    html, body {
      margin: 0;
      padding: 0;
      height: 100%; / Garante que html e body ocupem 100% da altura /
      width: 100%;  / Garante que html e body ocupem 100% da largura /
      overflow-x: hidden; / Permite rolagem vertical, mas previne horizontal /
      box-sizing: border-box; / Garante que padding e border sejam incluídos no cálculo de width/height /
    }

    body {
      background-color: #1a1a1a; / Fundo padrão do body (para outras seções/quando nenhum tema está ativo) /
      color: white;
      font-family: Arial, sans-serif;
    }

    / Animação para o efeito de "fumaça" /
    @keyframes fumaca {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    / Estilos base para a classe .container (aplicados a todas as seções) /
    .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
    }

    / ESTILOS ESPECÍFICOS PARA A TELA INICIAL (#mainMenu) - Ocupando 100% da tela /
    #mainMenu {
      width: 100vw;
      height: 100vh;
      max-width: none;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      background: linear-gradient(-45deg, #1abc9c, #3498db, #16a085, #2980b9);
      background-size: 400% 400%;
      animation: fumaca 20s ease infinite;
      border-radius: 0;
      box-shadow: none;
      overflow: hidden;
    }

    / Estilos para os outros containers (TODAS AS OUTRAS ABAS, EXCETO A INICIAL) /
    .container:not(#mainMenu) {
        min-height: calc(100vh - 40px);
        padding: 15px;
        max-width: 500px;
        margin: auto;
        margin-top: 20px;
        margin-bottom: 20px;
        overflow-y: auto; 
    }

    / Temas para as maquininhas - aplicados ao body dinamicamente /
    body.pagbank { background-color: #fff8dc; color: #000; }
    body.infinity { background-color: #000; color: #fff; }
    body.valorante { background-color: #2f4f4f; color: #fff; }

    .hidden { display: none !important; }
    select, input { border-radius: 15px !important; }
    .single-line { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95rem; }
    .d-grid button { width: 100%; max-width: 300px; margin-bottom: 10px; }
    .form-select, .form-control { width: 100%; max-width: 400px; }
    .alert { width: 100%; max-width: 400px; }

    / Styles for the Administration section /
    #administracao.container {
        max-width: 900px;
        background-color: #000 !important;
        color: #fff !important;
    }
    #administracao .table-dark th, #administracao .table-dark td {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.2);
    }
    #administracao .table-dark tbody tr:nth-of-type(odd) { background-color: rgba(255, 255, 255, 0.1); }
    #administracao .form-control,
    #administracao textarea.form-control {
        background-color: rgba(255, 255, 255, 0.2);
        color: white !important;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    #administracao .form-control::placeholder { color: rgba(255, 255, 255, 0.7) !important; }
    #administracao .form-control:focus { background-color: rgba(255, 255, 255, 0.3); border-color: #007bff; box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25); }
    #administracao .btn-primary { background-color: #007bff; border-color: #007bff; }
    #administracao .btn-primary:hover { background-color: #0056b3; border-color: #0056b3; }
    #administracao .btn-secondary { background-color: #6c757d; border-color: #6c757d; color: #fff; }
    #administracao .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; }
    #administracao .btn-danger { background-color: #dc3545; border-color: #dc3545; }
    #administracao .btn-danger:hover { background-color: #c82333; border-color: #bd2130; }
    #administracao .btn-success { background-color: #28a745; border-color: #28a745; }
    #administracao .btn-success:hover { background-color: #218838; border-color: #1e7e34; }
    #administracao .btn-info { background-color: #17a2b8; border-color: #17a2b8; }
    #administracao .btn-info:hover { background-color: #138496; border-color: #117a8b; }

    .btn-danger-lg {
        background-color: #dc3545; border-color: #dc3545; font-size: 1.25rem; padding: 0.8rem 1.5rem;
        width: 100%; max-width: 300px; margin-top: 20px;
    }
    .btn-danger-lg:hover { background-color: #c82333; border-color: #bd2130; }

    @media (max-width: 576px) {
        .container:not(#mainMenu) { padding: 10px; }
        h2, h3 { font-size: 1.5rem; }
        .btn-lg { font-size: 1rem; padding: 0.75rem 1rem; }
        .row .col-12 { margin-bottom: 10px; }
    }

    .user-id-display {
      position: fixed; bottom: 10px; left: 10px; background-color: rgba(0, 0, 0, 0.6);
      color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.75rem; z-index: 1000;
    }

    .custom-modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7);
        display: flex; justify-content: center; align-items: center; z-index: 9999;
    }
    .custom-modal-content {
        background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        text-align: center; max-width: 400px; width: 90%; color: #333;
    }
    .custom-modal-content h4 { margin-top: 0; margin-bottom: 20px; color: #333; }
    .custom-modal-content input[type="password"] {
        width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc;
        border-radius: 5px; box-sizing: border-box;
    }
    .custom-modal-content button {
        margin: 5px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;
    }
    .custom-modal-content .btn-ok { background-color: #007bff; color: white; }
    .custom-modal-content .btn-cancel { background-color: #6c757d; color: white; }
  </style>
</head>
<body>
  <div class="container text-center" id="mainMenu">
    <h2 class="mb-4">Bem vindo(a) a calculadora de taxas Workcell,<br>O que você quer fazer?</h2>
    <div class="d-grid gap-2">
      <button id="btn-goto-fecharVenda" class="btn btn-primary btn-lg">Fechar uma venda</button>
      <button id="btn-goto-repassarValores" class="btn btn-dark btn-lg">Repassar valores</button>
      <button id="btn-goto-calcularPorAparelho" class="btn btn-info btn-lg">Calcular por aparelho</button>
      <button id="btn-goto-administracao" class="btn btn-secondary btn-lg">Administração de Produtos</button>
    </div>
  </div>

  <div class="container hidden" id="fecharVenda">
    <h3 class="mb-4">Taxas de Maquininha e Fechamento de Venda</h3>
    <div class="row mb-3 w-100 justify-content-center">
      <div class="col-12 col-md-4 mb-3">
        <label>Maquininha</label>
        <select class="form-select" id="machine1">
          <option value="pagbank">PagBank</option>
          <option value="infinity">InfinityPay</option>
          <option value="valorante">Valorante</option>
        </select>
      </div>
      <div class="col-12 col-md-4 mb-3" id="brand1Container">
        <label>Bandeira</label>
        <select class="form-select" id="brand1">
          <option value="visa">Visa / Master</option>
          <option value="hiper">Hipercard</option>
          <option value="elo">Elo</option>
          <option value="amex">Amex</option>
        </select>
      </div>
      <div class="col-12 col-md-4 mb-3">
        <label>Parcelas</label>
        <select class="form-select" id="installments1"></select>
      </div>
    </div>
    <div class="mb-3 d-flex justify-content-center flex-wrap">
      <label class="me-3"><input type="radio" name="modeFechar" id="radioTotal" value="total" checked /> Valor total da venda</label>
      <label><input type="radio" name="modeFechar" id="radioParcela" value="parcela" /> Modo parcelas</label>
    </div>
    <div id="fecharVendaInputs" class="w-100 d-flex justify-content-center"></div>
    <div id="resultFecharVenda" class="w-100 d-flex justify-content-center"></div>
    <button class="btn btn-outline-secondary mt-4" id="btn-fecharVenda-back">Voltar</button>
  </div>

  <div class="container hidden" id="repassarValores">
    <h3 class="mb-4">Simulação para Clientes</h3>
    <div class="row mb-3 w-100 justify-content-center">
      <div class="col-12 col-md-6 mb-3">
        <label>Maquininha</label>
        <select class="form-select" id="machine2">
          <option value="pagbank">PagBank</option>
          <option value="infinity">InfinityPay</option>
          <option value="valorante">Valorante</option>
        </select>
      </div>
      <div class="col-12 col-md-6 mb-3" id="brand2Container">
        <label>Bandeira</label>
        <select class="form-select" id="brand2">
          <option value="visa">Visa / Master</option>
          <option value="hiper">Hipercard</option>
          <option value="elo">Elo</option>
          <option value="amex">Amex</option>
        </select>
      </div>
    </div>
    <input type="number" step="0.01" min="0" id="repassarValue" class="form-control form-control-lg mb-3 w-100" style="max-width: 400px;" placeholder="Digite o valor desejado (líquido)" />
    <div id="resultRepassarValores" class="w-100 d-flex flex-column align-items-center"></div>
    <button class="btn btn-outline-secondary mt-4" id="btn-repassarValores-back">Voltar</button>
  </div>

  <div class="container hidden" id="calcularPorAparelho">
    <h3 class="mb-4">Calcular por Aparelho</h3>
    <div class="mb-3 w-100" style="max-width: 400px;">
        <label for="aparelhoSearch" class="form-label">Pesquisar Aparelho</label>
        <input type="text" class="form-control" id="aparelhoSearch" placeholder="Digite o nome do aparelho">
    </div>
    <div class="row mb-3 w-100 justify-content-center">
      <div class="col-12 col-md-8">
        <label>Aparelho</label>
        <select class="form-select" id="aparelhoSelect">
          <option value="">Selecione um aparelho</option>
        </select>
      </div>
    </div>
    <div class="row mb-3 w-100 justify-content-center">
        <div class="col-12 col-md-6 mb-3">
            <label>Maquininha</label>
            <select class="form-select" id="machine3">
                <option value="pagbank">PagBank</option>
                <option value="infinity">InfinityPay</option>
                <option value="valorante">Valorante</option>
            </select>
        </div>
        <div class="col-12 col-md-6 mb-3" id="brand3Container">
            <label>Bandeira</label>
            <select class="form-select" id="brand3">
                <option value="visa">Visa / Master</option>
                <option value="hiper">Hipercard</option>
                <option value="elo">Elo</option>
                <option value="amex">Amex</option>
            </select>
        </div>
    </div>
    <div id="resultCalcularPorAparelho" class="w-100 d-flex flex-column align-items-center"></div>
    <button class="btn btn-outline-secondary mt-4" id="btn-calcularPorAparelho-back">Voltar</button>
  </div>

  <div class="container hidden" id="administracao">
    <h3 class="mb-4">Administração de Produtos</h3>
    <div id="loadingMessage" class="alert alert-info mt-3 hidden">Carregando produtos...</div>
    <div id="errorMessage" class="alert alert-danger mt-3 hidden">Ocorreu um erro.</div>

    <div class="mb-4 text-start">
        <h4 class="text-white mb-3">Importar Produtos</h4>
        <div class="mb-3">
            <label for="pasteInput" class="form-label">Colar Lista (Ex: iPhone 14 - 3999.00):</label>
            <textarea class="form-control" id="pasteInput" rows="5" placeholder="Cole sua lista de produtos aqui, um por linha."></textarea>
        </div>
        <button class="btn btn-primary mb-3 me-2" id="btn-import-paste">Importar Colados</button>
        <button class="btn btn-secondary mb-3" id="btn-upload-file">Upload de Arquivo (.txt/.csv)</button>
        <input type="file" id="fileInput" accept=".txt,.csv" class="d-none">
        <div id="importStatus" class="mt-2"></div>
    </div>

    <div class="mb-4 text-start">
        <h4 class="text-white mb-3">Pesquisar Produtos</h4>
        <div class="mb-3">
            <input type="text" class="form-control" id="adminSearchInput" placeholder="Digite o nome do produto para pesquisar...">
        </div>
    </div>
    
    <div class="mb-4 text-start">
        <h4 class="text-white mb-3">Comando Rápido (IA*)</h4>
        <div class="input-group">
            <input type="text" class="form-control" id="naturalCommandInput" placeholder="Ex: baixar valor iPhone 13 para 3399" />
            <button class="btn btn-primary" id="btn-apply-command">Aplicar Comando</button>
        </div>
        <div id="commandStatus" class="mt-2"></div>
    </div>

    <div class="mb-4 text-start">
        <h4 class="text-white mb-3">Produtos Cadastrados</h4>
        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover">
                <thead>
                    <tr>
                        <th>Nome do Produto</th>
                        <th>Valor</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
            </table>
        </div>
        <button class="btn btn-success mt-3" id="btn-add-new-product">Adicionar Novo Produto</button>
    </div>

    <div class="mb-4 text-start">
        <h4 class="text-white mb-3">Exportar Produtos</h4>
        <button class="btn btn-info me-2" id="btn-export-txt">Exportar como TXT</button>
        <button class="btn btn-info" id="btn-export-json">Exportar como JSON</button>
    </div>

    <div class="mb-4 text-start">
        <button class="btn btn-danger-lg" id="btn-delete-all">Excluir todos os produtos</button>
    </div>

    <button class="btn btn-outline-secondary mt-4" id="btn-administracao-back">Voltar</button>
  </div>

  <div id="userIdDisplay" class="user-id-display hidden"></div>
  <div id="customModalOverlay" class="custom-modal-overlay hidden">
    <div class="custom-modal-content">
      <h4 id="customModalMessage"></h4>
      <input type="password" id="customModalPasswordInput" placeholder="Digite a senha (se necessário)" class="hidden"/>
      <div id="customModalButtons">
        <button class="btn-ok">OK</button>
        <button class="btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getDatabase, ref, push, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    // --- VARIÁVEIS GLOBAIS ---
    let app, db, auth;
    let userId = null;
    let isAuthReady = false;
    let products = [];
    let selectedAparelhoValue = 0;
    let currentSectionId = 'mainMenu';

    const firebaseConfig = {
      apiKey: "AIzaSyBt0LbXsXZEKlctfuCPM0G5rd8MqnzYNRw",
      authDomain: "calculadora-de-taxas-b3f1f.firebaseapp.com",
      databaseURL: "https://calculadora-de-taxas-b3f1f-default-rtdb.firebaseio.com",
      projectId: "calculadora-de-taxas-b3f1f",
      storageBucket: "calculadora-de-taxas-b3f1f.firebasestorage.app",
      messagingSenderId: "149501336928",
      appId: "1:149501336928:web:05ff020a37756c6bd9d205"
    };

    const rates = {
      pagbank: { debito: 0.99, credito: [2.99, 4.09, 4.78, 5.47, 6.14, 6.81, 7.67, 8.33, 8.98, 9.63, 10.26, 10.90, 12.32, 12.94, 13.56, 14.17, 14.77, 15.37] },
      infinity: {
        visa: { debito: 0.75, credito: [2.69, 3.94, 4.46, 4.98, 5.49, 5.99, 6.51, 6.99, 7.51, 7.99, 8.49, 8.99] },
        hiper: { debito: 1.88, credito: [4.46, 5.81, 6.32, 6.83, 7.33, 7.83, 8.34, 8.83, 9.32, 9.81, 10.29, 10.77] }
      },
      valorante: {
        visa: { debito: 0.95, credito: [3.45, 4.73, 5.47, 6.08, 6.57, 7.45, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 11.96, 12.64, 13.32, 14.00, 14.68, 15.36, 16.04, 16.72, 17.40] },
        mastercard: { debito: 0.95, credito: [3.45, 4.73, 5.47, 6.08, 6.57, 7.45, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 11.96, 12.64, 13.32, 14.00, 14.68, 15.36, 16.04, 16.72, 17.40] },
        elo: { debito: 1.69, credito: [3.65, 5.43, 6.11, 6.70, 7.17, 8.15, 9.13, 9.81, 11.17, 11.85, 12.53, 12.66, 13.39, 14.57, 15.25, 15.93, 16.61, 17.23, 17.97, 18.65] },
        hipercard: { debito: 0.95, credito: [3.95, 4.93, 5.61, 6.22, 6.71, 7.65, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 12.51, 13.19, 13.87, 14.55, 15.23, 15.91, 16.53, 17.21, 17.95] },
        amex: { debito: 0.95, credito: [3.95, 4.93, 5.61, 6.22, 6.71, 7.65, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 12.51, 13.19, 13.87, 14.55, 15.23, 15.91, 16.53, 17.21, 17.95] }
      }
    };
    
    // --- FUNÇÕES DE NAVEGAÇÃO E ESTADO ---

    function openSection(sectionId, fromHistory = false) {
        document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');
        currentSectionId = sectionId;

        // Resetar e inicializar a seção
        if (sectionId === 'mainMenu') {
            document.body.className = ''; 
        } else {
            if (sectionId === 'fecharVenda') resetFecharVenda();
            if (sectionId === 'repassarValores') resetRepassarValores();
            if (sectionId === 'calcularPorAparelho') resetCalcularPorAparelho();
            if (sectionId === 'administracao') resetAdministracao();
        }
        
        if (!fromHistory) {
            history.pushState({ sectionId: sectionId }, '', `#${sectionId}`);
        }
    }

    function updateTheme(machine) {
        if (currentSectionId !== 'administracao') {
            document.body.className = machine;
        }
    }

    window.addEventListener('popstate', (event) => {
        const targetSectionId = event.state ? event.state.sectionId : 'mainMenu';
        openSection(targetSectionId, true); 
    });

    // --- FUNÇÕES DE RESET DE PÁGINA ---
    
    function resetFecharVenda() {
        updateTheme('pagbank');
        updateInstallmentsOptions();
        updateBrandVisibility();
        toggleFecharVendaMode();
        document.getElementById('resultFecharVenda').innerHTML = '';
    }

    function resetRepassarValores() {
        updateTheme('pagbank');
        document.getElementById('repassarValue').value = '';
        document.getElementById('resultRepassarValores').innerHTML = '';
        updateBrandVisibility();
    }
    
    function resetCalcularPorAparelho() {
        updateTheme('pagbank');
        document.getElementById('aparelhoSearch').value = '';
        document.getElementById('resultCalcularPorAparelho').innerHTML = '';
        loadProductsFromRTDB();
        updateBrandVisibilityAparelho();
    }
    
    function resetAdministracao() {
        document.body.className = 'infinity';
        document.getElementById('adminSearchInput').value = '';
        document.getElementById('naturalCommandInput').value = '';
        document.getElementById('pasteInput').value = '';
        document.getElementById('importStatus').innerHTML = '';
        document.getElementById('commandStatus').innerHTML = '';
        loadProductsFromRTDB();
    }

    // --- LÓGICA DE CÁLCULO 'FECHAR VENDA' ---

    function updateInstallmentsOptions() {
      const machine = document.getElementById("machine1").value;
      const installments = document.getElementById("installments1");
      installments.innerHTML = '<option value="0">Débito</option>';
      let max = (machine === "pagbank") ? 18 : (machine === "infinity") ? 12 : 21;
      for (let i = 1; i <= max; i++) {
        installments.innerHTML += `<option value="${i}">${i}x</option>`;
      }
    }

    function updateBrandVisibility() {
      const machine1 = document.getElementById("machine1").value;
      const machine2 = document.getElementById("machine2").value;
      document.getElementById("brand1Container").style.display = (machine1 === "infinity" || machine1 === "valorante") ? "block" : "none";
      document.getElementById("brand2Container").style.display = (machine2 === "infinity" || machine2 === "valorante") ? "block" : "none";
    }

    function toggleFecharVendaMode() {
      const mode = document.querySelector('input[name="modeFechar"]:checked').value;
      const inputsDiv = document.getElementById("fecharVendaInputs");
      if (mode === "total") {
        inputsDiv.innerHTML = `<input type="number" step="0.01" min="0" id="fecharVendaValue" class="form-control form-control-lg mb-3" placeholder="Digite o valor total da venda" style="max-width: 400px;"/>`;
        document.getElementById("fecharVendaValue").addEventListener('input', calculateFecharVenda);
      } else {
        inputsDiv.innerHTML = `<input type="number" step="0.01" min="0" id="fecharVendaValueParcela" class="form-control form-control-lg mb-3" placeholder="Digite o valor da parcela" style="max-width: 400px;"/>`;
        document.getElementById("fecharVendaValueParcela").addEventListener('input', calculateFecharVenda);
      }
    }

    function calculateFecharVenda() {
      const machine = document.getElementById("machine1").value;
      const brand = document.getElementById("brand1").value || "visa";
      const mode = document.querySelector('input[name="modeFechar"]:checked').value;
      const installments = parseInt(document.getElementById("installments1").value);
      let value = 0;

      if (mode === "total") {
        value = parseFloat(document.getElementById("fecharVendaValue")?.value);
      } else {
        const parcela = parseFloat(document.getElementById("fecharVendaValueParcela")?.value);
        if (!isNaN(parcela) && parcela > 0) {
            value = parcela * (installments === 0 ? 1 : installments);
        }
      }

      const resultDiv = document.getElementById("resultFecharVenda");
      if (isNaN(value) || value <= 0) {
        resultDiv.innerHTML = "";
        return;
      }
      
      let tax = 0;
      if (machine === "pagbank") {
        tax = installments === 0 ? rates.pagbank.debito : rates.pagbank.credito[installments - 1];
      } else if (machine === "infinity") {
        let infinityBrand = (brand === 'hiper' || brand === 'elo' || brand === 'amex') ? 'hiper' : 'visa';
        tax = installments === 0 ? rates.infinity[infinityBrand].debito : rates.infinity[infinityBrand].credito[installments - 1];
      } else if (machine === "valorante") {
        let valoranteBrand = brand === 'hiper' ? 'hipercard' : brand;
        tax = installments === 0 ? (rates.valorante[valoranteBrand]?.debito) : (rates.valorante[valoranteBrand]?.credito[installments - 1]);
      }

      const liquid = value * (1 - (tax || 0) / 100);
      resultDiv.innerHTML = `
        <div class="alert alert-success fs-5 w-100" style="max-width: 400px;">
          <strong>Valor Líquido: </strong>R$ ${liquid.toFixed(2)} <br/>
          Taxa aplicada: ${(tax || 0).toFixed(2)}% (${installments === 0 ? "Débito" : `${installments}x`})
        </div>`;
    }

    // --- LÓGICA DE CÁLCULO 'REPASSAR VALORES' ---
    
    function calculateRepassarValores() {
      const valorDesejado = parseFloat(document.getElementById("repassarValue").value);
      const resultDiv = document.getElementById("resultRepassarValores");
      if (isNaN(valorDesejado) || valorDesejado <= 0) {
        resultDiv.innerHTML = "";
        return;
      }

      const machine = document.getElementById("machine2").value;
      const brand = document.getElementById("brand2").value || "visa";
      let maxInstallments = (machine === "pagbank") ? 18 : (machine === "infinity") ? 12 : 21;
      let resultHtml = "";
      
      let actualBrand = brand.toLowerCase();
      if (machine === 'valorante') actualBrand = actualBrand === 'hiper' ? 'hipercard' : actualBrand;
      else if (machine === 'infinity') actualBrand = (actualBrand === 'hiper' || actualBrand === 'elo' || actualBrand === 'amex') ? 'hiper' : 'visa';

      let debitTax = 0;
      if (machine === "pagbank") debitTax = rates.pagbank.debito;
      else if (machine === "infinity") debitTax = rates.infinity[actualBrand]?.debito;
      else if (machine === "valorante") debitTax = rates.valorante[actualBrand]?.debito;
      
      const valorBrutoDebit = valorDesejado / (1 - (debitTax || 0) / 100);
      resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">Débito: R$ ${valorBrutoDebit.toFixed(2)} (${(debitTax || 0).toFixed(2)}%)</div>`;

      for (let i = 1; i <= maxInstallments; i++) {
        let creditTax = 0;
        if (machine === "pagbank") creditTax = rates.pagbank.credito[i - 1];
        else if (machine === "infinity") creditTax = rates.infinity[actualBrand]?.credito[i - 1];
        else if (machine === "valorante") creditTax = rates.valorante[actualBrand]?.credito[i - 1];

        const valorBrutoCredit = valorDesejado / (1 - (creditTax || 0) / 100);
        const valorParcela = valorBrutoCredit / i;
        resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">${i}x de R$ ${valorParcela.toFixed(2)} (Total: R$ ${valorBrutoCredit.toFixed(2)})</div>`;
      }
      resultDiv.innerHTML = resultHtml;
    }

    // --- LÓGICA DE CÁLCULO 'POR APARELHO' ---
    
    function updateBrandVisibilityAparelho() {
        const machine3 = document.getElementById("machine3").value;
        document.getElementById("brand3Container").style.display = (machine3 === "infinity" || machine3 === "valorante") ? "block" : "none";
        calculateAparelho();
    }

    function calculateAparelho() {
        const machine = document.getElementById("machine3").value;
        const brand = document.getElementById("brand3").value || "visa";
        const resultDiv = document.getElementById('resultCalcularPorAparelho');

        if (isNaN(selectedAparelhoValue) || selectedAparelhoValue <= 0) {
            resultDiv.innerHTML = `<div class="alert alert-warning mt-3 w-100" style="max-width: 400px;">Selecione um aparelho para calcular.</div>`;
            return;
        }

        let maxInstallments = (machine === "pagbank") ? 18 : (machine === "infinity") ? 12 : 21;
        let resultHtml = `<h4 class="mt-4">Resultados para R$ ${selectedAparelhoValue.toFixed(2)}</h4>`;

        let actualBrand = brand.toLowerCase();
        if (machine === 'valorante') actualBrand = actualBrand === 'hiper' ? 'hipercard' : actualBrand;
        else if (machine === 'infinity') actualBrand = (actualBrand === 'hiper' || actualBrand === 'elo' || actualBrand === 'amex') ? 'hiper' : 'visa';

        let debitTax = 0;
        if (machine === "pagbank") debitTax = rates.pagbank.debito;
        else if (machine === "infinity") debitTax = rates.infinity[actualBrand]?.debito;
        else if (machine === "valorante") debitTax = rates.valorante[actualBrand]?.debito;

        const valorBrutoDebit = selectedAparelhoValue / (1 - (debitTax || 0) / 100);
        resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">Débito: R$ ${valorBrutoDebit.toFixed(2)} (${(debitTax || 0).toFixed(2)}%)</div>`;

        for (let i = 1; i <= maxInstallments; i++) {
            let creditTax = 0;
            if (machine === "pagbank") creditTax = rates.pagbank.credito[i - 1];
            else if (machine === "infinity") creditTax = rates.infinity[actualBrand]?.credito[i - 1];
            else if (machine === "valorante") creditTax = rates.valorante[actualBrand]?.credito[i - 1];

            const valorBrutoCredit = selectedAparelhoValue / (1 - (creditTax || 0) / 100);
            const valorParcela = valorBrutoCredit / i;
            resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">${i}x de R$ ${valorParcela.toFixed(2)} (Total: R$ ${valorBrutoCredit.toFixed(2)})</div>`;
        }
        resultDiv.innerHTML = resultHtml;
    }
    
    function populateAparelhoSelect(filteredProducts = products) { 
        const aparelhoSelect = document.getElementById('aparelhoSelect');
        aparelhoSelect.innerHTML = '<option value="">Selecione um aparelho</option>'; 
        if (filteredProducts.length === 0) {
            aparelhoSelect.innerHTML = '<option value="">Nenhum produto cadastrado</option>';
            return;
        }
        filteredProducts.forEach(p => {
            const option = document.createElement('option');
            option.value = parseFloat(p.valor || 0); 
            option.textContent = `${p.nome || 'Desconhecido'} - R$ ${(p.valor || 0).toFixed(2)}`;
            aparelhoSelect.appendChild(option);
        });
        if (filteredProducts.length > 0) {
            aparelhoSelect.value = parseFloat(filteredProducts[0].valor || 0);
            selectedAparelhoValue = parseFloat(filteredProducts[0].valor || 0);
            calculateAparelho();
        }
    }
    
    function filterAparelhos() {
        const searchTerm = normalizeString(document.getElementById('aparelhoSearch').value);
        const keywords = searchTerm.split(' ').filter(word => word.length > 0);
        const filtered = products.filter(product => {
            const normalizedProductName = normalizeString(product.nome || '');
            return keywords.every(keyword => normalizedProductName.includes(keyword));
        });
        populateAparelhoSelect(filtered); 
    }

    // --- LÓGICA DE ADMINISTRAÇÃO E FIREBASE ---
    
    const getProductsRef = () => ref(db, 'products');

    function loadProductsFromRTDB() {
        if (!db || !isAuthReady) return;
        displayMessage('loadingMessage', 'Carregando produtos...', 'info');
        onValue(getProductsRef(), (snapshot) => {
            products = [];
            snapshot.forEach(child => {
                products.push({ id: child.key, ...child.val() });
            });
            if (currentSectionId === 'administracao') filterAdminProducts();
            if (currentSectionId === 'calcularPorAparelho') filterAparelhos();
            displayMessage('loadingMessage', 'Produtos carregados!', 'success');
        }, (error) => {
            console.error("Firebase Read Error:", error);
            displayMessage('errorMessage', `Erro ao carregar: ${error.message}`, 'danger');
        });
    }

    async function addNewProductRow() {
        await push(getProductsRef(), { nome: 'Novo Produto', valor: 0.00 });
    }

    async function editProductInRTDB(id, field, value) {
        let newValue = value;
        if (field === 'valor') {
            const parsedValue = parseBrazilianCurrencyToFloat(value);
            if (isNaN(parsedValue)) {
                displayStatusAdmin('Erro: Valor inválido.', 'danger');
                return;
            }
            newValue = parsedValue;
        }
        await update(ref(db, `products/${id}`), { [field]: newValue });
        displayStatusAdmin('Produto atualizado!', 'success');
    }

    async function deleteProductFromRTDB(id) {
        showCustomConfirm('Tem certeza que deseja excluir este produto?', async () => {
            hideCustomModal();
            await remove(ref(db, `products/${id}`));
            displayStatusAdmin('Produto excluído!', 'success');
        });
    }

    function renderAdminTable(list = products) {
        const tableBody = document.getElementById('productsTableBody');
        tableBody.innerHTML = ''; 
        if (list.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhum produto.</td></tr>';
            return;
        }
        list.forEach(product => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td><input type="text" class="form-control" data-id="${product.id}" data-field="nome" value="${escapeHtml(product.nome || '')}"></td>
                <td><input type="text" class="form-control" data-id="${product.id}" data-field="valor" value="${(product.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}"></td>
                <td><button class="btn btn-danger btn-sm btn-delete-product" data-id="${product.id}">Excluir</button></td>
            `;
        });
    }

    function filterAdminProducts() {
        const searchTerm = normalizeString(document.getElementById('adminSearchInput').value);
        const keywords = searchTerm.split(' ').filter(w => w.length > 0);
        const filtered = products.filter(p => {
            const productName = normalizeString(p.nome || '');
            return keywords.every(k => productName.includes(k));
        });
        renderAdminTable(filtered);
    }
    
    // --- LÓGICA DE IMPORT/EXPORT E COMANDOS ---

    async function importFromLines(lines, sourceName) {
        const regex = /^(.+?)\s*-\s*([\d.,]+)$/;
        const productsToImport = lines.map(line => {
            const match = line.match(regex);
            if (!match) return null;
            const nome = match[1].trim();
            const valor = parseBrazilianCurrencyToFloat(match[2]);
            return (nome && !isNaN(valor)) ? { nome, valor } : null;
        }).filter(Boolean);

        if (productsToImport.length > 0) {
            displayMessage('importStatus', `Importando ${productsToImport.length} produtos...`, 'info');
            try {
                const updates = {};
                productsToImport.forEach(p => {
                    const newKey = push(getProductsRef()).key;
                    updates[newKey] = p;
                });
                await update(getProductsRef(), updates);
                displayMessage('importStatus', `${productsToImport.length} produtos importados de ${sourceName}.`, 'success');
                return true;
            } catch (error) {
                displayMessage('importStatus', `Erro ao importar: ${error.message}`, 'danger');
            }
        } else {
            displayMessage('importStatus', 'Nenhum produto válido encontrado para importar.', 'warning');
        }
        return false;
    }
    
    async function processNaturalLanguageCommand() {
        const commandText = document.getElementById('naturalCommandInput').value.trim();
        if (!commandText) return;
        const match = commandText.match(/(.*?)\s*([\d.,]+)\s*$/);
        if (!match) { displayCommandStatus('Comando inválido.', 'danger'); return; }

        const productNamePart = match[1];
        const valueString = match[2];
        const newValue = parseBrazilianCurrencyToFloat(valueString);
        if (isNaN(newValue)) { displayCommandStatus('Valor inválido.', 'danger'); return; }

        const ignoreWords = ['baixar', 'valor', 'preco', 'preço', 'atualizar', 'mudar', 'trocar', 'para', 'de', 'novo', 'usado', 'do'];
        const searchTerms = normalizeString(productNamePart).split(/\s+/).filter(w => w && !ignoreWords.includes(w));
        if (searchTerms.length === 0) { displayCommandStatus('Nome do produto não identificado.', 'danger'); return; }

        const targetProduct = products.find(p => {
            const productName = normalizeString(p.nome || '');
            return searchTerms.every(term => productName.includes(term));
        });

        if (!targetProduct) { displayCommandStatus('Produto não encontrado.', 'warning'); return; }

        const oldPriceFmt = (targetProduct.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const newPriceFmt = newValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        showCustomConfirm(`Atualizar "${targetProduct.nome}" de ${oldPriceFmt} para ${newPriceFmt}?`, async () => {
            hideCustomModal();
            await editProductInRTDB(targetProduct.id, 'valor', newValue);
            displayCommandStatus('Valor atualizado com sucesso!', 'success');
            document.getElementById('naturalCommandInput').value = ''; 
        });
    }

    async function deleteAllProducts() {
        showCustomConfirm("ATENÇÃO: Para excluir TODOS os produtos, digite a senha.", async () => {
            const enteredPassword = document.getElementById('customModalPasswordInput').value;
            if (enteredPassword === "excluir") {
                hideCustomModal();
                showCustomConfirm("Esta ação é IRREVERSÍVEL. Tem certeza ABSOLUTA?", async () => {
                    hideCustomModal();
                    displayStatusAdmin('Excluindo todos os produtos...', 'info');
                    await remove(getProductsRef());
                    displayStatusAdmin('Todos os produtos foram excluídos.', 'success');
                });
            } else {
                hideCustomModal();
                showCustomAlert("Senha incorreta. Operação cancelada.");
            }
        }, null, true);
    }
    
    function exportProducts(format) {
        let dataStr, filename, mimeType;
        if (format === 'txt') {
            dataStr = products.map(p => `${p.nome || 'Sem Nome'} - ${(p.valor || 0).toFixed(2).replace('.', ',')}`).join('\n');
            filename = 'products.txt'; mimeType = 'text/plain';
        } else if (format === 'json') {
            dataStr = JSON.stringify(products, null, 2);
            filename = 'products.json'; mimeType = 'application/json';
        } else return;
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([dataStr], { type: mimeType }));
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        displayStatusAdmin(`Produtos exportados como ${format.toUpperCase()}.`, 'success');
    }

    // --- FUNÇÕES UTILITÁRIAS ---

    const normalizeString = str => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9\s]/gi, "");
    const escapeHtml = text => String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);
    
    function parseBrazilianCurrencyToFloat(valueString) {
        if (typeof valueString !== 'string') valueString = String(valueString);
        const cleaned = valueString.replace(/R\$|\s/g, '').replace(/\./g, '').replace(',', '.');
        return parseFloat(cleaned);
    }

    function displayMessage(elementId, message, type) {
        const el = document.getElementById(elementId);
        if(!el) return;
        el.textContent = message;
        el.className = `alert alert-${type} mt-3`;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 5000); 
    }
    const displayStatusAdmin = (msg, type) => displayMessage('importStatus', msg, type);
    const displayCommandStatus = (msg, type) => displayMessage('commandStatus', msg, type);
    
    // --- FUNÇÕES DO MODAL ---
    const customModalOverlay = document.getElementById('customModalOverlay');
    function hideCustomModal() { customModalOverlay.classList.add('hidden'); }
    function showCustomConfirm(message, onConfirm, onCancel = null, showPassword = false) {
        document.getElementById('customModalMessage').textContent = message;
        const passInput = document.getElementById('customModalPasswordInput');
        passInput.classList.toggle('hidden', !showPassword);
        passInput.value = '';
        customModalOverlay.querySelector('.btn-ok').onclick = onConfirm;
        customModalOverlay.querySelector('.btn-cancel').onclick = () => { hideCustomModal(); if(onCancel) onCancel(); };
        customModalOverlay.querySelector('.btn-cancel').classList.remove('hidden');
        customModalOverlay.classList.remove('hidden');
        if(showPassword) passInput.focus();
    }
    function showCustomAlert(message) {
        document.getElementById('customModalMessage').textContent = message;
        document.getElementById('customModalPasswordInput').classList.add('hidden');
        customModalOverlay.querySelector('.btn-ok').onclick = hideCustomModal;
        customModalOverlay.querySelector('.btn-cancel').classList.add('hidden');
        customModalOverlay.classList.remove('hidden');
    }

    // --- INICIALIZAÇÃO E EVENT LISTENERS ---

    function initializeEventListeners() {
        // Navegação Principal
        document.getElementById('btn-goto-fecharVenda').addEventListener('click', () => openSection('fecharVenda'));
        document.getElementById('btn-goto-repassarValores').addEventListener('click', () => openSection('repassarValores'));
        document.getElementById('btn-goto-calcularPorAparelho').addEventListener('click', () => openSection('calcularPorAparelho'));
        document.getElementById('btn-goto-administracao').addEventListener('click', () => openSection('administracao'));
        document.querySelectorAll('[id$="-back"]').forEach(btn => btn.addEventListener('click', () => openSection('mainMenu')));

        // Aba: Fechar Venda
        document.getElementById('machine1').addEventListener('change', () => { updateTheme('machine1'); updateInstallmentsOptions(); updateBrandVisibility(); calculateFecharVenda(); });
        document.getElementById('brand1').addEventListener('change', calculateFecharVenda);
        document.getElementById('installments1').addEventListener('change', calculateFecharVenda);
        document.getElementById('radioTotal').addEventListener('change', toggleFecharVendaMode);
        document.getElementById('radioParcela').addEventListener('change', toggleFecharVendaMode);
        
        // Aba: Repassar Valores
        document.getElementById('machine2').addEventListener('change', () => { updateTheme('machine2'); updateBrandVisibility(); calculateRepassarValores(); });
        document.getElementById('brand2').addEventListener('change', calculateRepassarValores);
        document.getElementById('repassarValue').addEventListener('input', calculateRepassarValores);

        // Aba: Calcular por Aparelho
        document.getElementById('aparelhoSearch').addEventListener('input', filterAparelhos);
        document.getElementById('aparelhoSelect').addEventListener('change', (e) => { selectedAparelhoValue = parseFloat(e.target.value); calculateAparelho(); });
        document.getElementById('machine3').addEventListener('change', () => { updateTheme('machine3'); updateBrandVisibilityAparelho(); });
        document.getElementById('brand3').addEventListener('change', calculateAparelho);
        
        // Aba: Administração
        document.getElementById('btn-import-paste').addEventListener('click', async () => {
            const lines = document.getElementById('pasteInput').value.split('\n').filter(Boolean);
            if (await importFromLines(lines, 'texto colado')) document.getElementById('pasteInput').value = '';
        });
        document.getElementById('btn-upload-file').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const text = await file.text();
            if (await importFromLines(text.split('\n').filter(Boolean), `"${file.name}"`)) e.target.value = '';
        });
        document.getElementById('adminSearchInput').addEventListener('input', filterAdminProducts);
        document.getElementById('btn-apply-command').addEventListener('click', processNaturalLanguageCommand);
        document.getElementById('btn-add-new-product').addEventListener('click', addNewProductRow);
        document.getElementById('btn-export-txt').addEventListener('click', () => exportProducts('txt'));
        document.getElementById('btn-export-json').addEventListener('click', () => exportProducts('json'));
        document.getElementById('btn-delete-all').addEventListener('click', deleteAllProducts);

        document.getElementById('productsTableBody').addEventListener('change', (e) => {
            if (e.target.tagName === 'INPUT') {
                const { id, field } = e.target.dataset;
                editProductInRTDB(id, field, e.target.value);
            }
        });
        document.getElementById('productsTableBody').addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-delete-product')) {
                deleteProductFromRTDB(e.target.dataset.id);
            }
        });
    }

    async function initFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    document.getElementById('userIdDisplay').textContent = `ID: ${userId}`;
                    document.getElementById('userIdDisplay').classList.remove('hidden');
                    console.log("Firebase Authenticated: ", userId);
                    loadProductsFromRTDB();
                } else {
                    await signInAnonymously(auth);
                }
            });
        } catch (error) {
            console.error("Firebase Init Error:", error);
            displayMessage('errorMessage', `Falha no Firebase: ${error.message}`, 'danger');
        }
    }
    
    // Ponto de entrada da aplicação
    document.addEventListener('DOMContentLoaded', () => {
        initializeEventListeners();
        initFirebase();
        history.replaceState({ sectionId: 'mainMenu' }, '', '#mainMenu');
    });

  </script>
</body>
</html>