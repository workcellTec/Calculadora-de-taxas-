<meta name='viewport' content='width=device-width, initial-scale=1'/>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calcule Taxas By Brendon</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* GARANTINDO QUE HTML E BODY OCUPEM A TELA INTEIRA SEM MARGENS/PADDINGS */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%; /* Garante que html e body ocupem 100% da altura */
      width: 100%;  /* Garante que html e body ocupem 100% da largura */
      overflow-x: hidden; /* Permite rolagem vertical, mas previne horizontal */
      box-sizing: border-box; /* Garante que padding e border sejam incluídos no cálculo de width/height */
    }

    body {
      background-color: #1a1a1a; /* Fundo padrão do body (para outras seções/quando nenhum tema está ativo) */
      color: white;
      font-family: Arial, sans-serif;
      /* O padding de 20px foi removido daqui para evitar bordas pretas */
    }

    /* Animação para o efeito de "fumaça" */
    @keyframes fumaca {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Estilos base para a classe .container (aplicados a todas as seções) */
    .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-sizing: border-box; /* Importante para o controle de tamanho */
        /* min-height, max-width, padding e margin serão definidos especificamente para #mainMenu
           ou para os outros containers usando o seletor :not(#mainMenu) */
    }

    /* ESTILOS ESPECÍFICOS PARA A TELA INICIAL (#mainMenu) - Ocupando 100% da tela */
    #mainMenu {
      width: 100vw;   /* Ocupa 100% da largura da viewport */
      height: 100vh;  /* Ocupa 100% da altura da viewport */
      max-width: none; /* Remove qualquer limite de largura imposto pelo .container */
      min-height: 100vh; /* Garante que ocupe pelo menos 100% da altura da viewport */
      margin: 0;      /* Remove quaisquer margens herdadas */
      padding: 0;     /* Remove quaisquer paddings herdados, para preencher totalmente */
      
      /* Gradiente e animação (conforme solicitado) */
      background: linear-gradient(-45deg, #1abc9c, #3498db, #16a085, #2980b9);
      background-size: 400% 400%;
      animation: fumaca 20s ease infinite;

      /* Assegura que não há bordas arredondadas ou sombras visíveis */
      border-radius: 0;
      box-shadow: none;
      
      overflow: hidden; /* Mantém o overflow hidden apenas para a tela inicial se desejar */
    }

    /* Estilos para os outros containers (TODAS AS OUTRAS ABAS, EXCETO A INICIAL) */
    .container:not(#mainMenu) {
        min-height: calc(100vh - 40px); /* Mantém o min-height para outras seções */
        padding: 15px; /* Padding interno para o conteúdo das outras seções */
        max-width: 500px; /* Limita a largura das outras seções */
        margin: auto; /* Centraliza as outras seções */
        margin-top: 20px; /* Margem para o topo em outras seções */
        margin-bottom: 20px; /* Margem para a base em outras seções */
        
        /* Permite rolagem vertical dentro desses containers se o conteúdo for maior */
        overflow-y: auto; 
    }

    /* Temas para as maquininhas - aplicados ao body dinamicamente */
    body.pagbank {
      background-color: #fff8dc; /* Amarelo claro */
      color: #000;
    }

    body.infinity {
      background-color: #000; /* Preto */
      color: #fff;
    }

    body.valorante {
      background-color: #2f4f4f; /* Verde musgo escuro */
      color: #fff;
    }

    /* Garante que elementos com 'hidden' não ocupem espaço */
    .hidden {
      display: none !important; /* Adicionado !important para forçar */
    }
    select, input {
      border-radius: 15px !important;
    }
    .single-line {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.95rem; /* você pode ajustar esse tamanho conforme necessário */
    }
    
    .d-grid button {
        width: 100%; /* Botões ocupam 100% da largura em telas pequenas */
        max-width: 300px; /* Limite a largura máxima para botões em telas maiores */
        margin-bottom: 10px; /* Espaçamento entre os botões */
    }
    .form-select, .form-control {
        width: 100%;
        max-width: 400px; /* Limite a largura máxima dos inputs e selects */
    }
    .alert {
        width: 100%;
        max-width: 400px;
    }
    /* Styles for the Administration section */
    #administracao.container {
        max-width: 900px; /* Wider for the table */
        /* FORÇAR TEMA ESCURO PARA ADMINISTRAÇÃO */
        background-color: #000 !important; /* Fundo preto do InfinityPay */
        color: #fff !important; /* Texto branco do InfinityPay */
    }
    #administracao .table-dark th, #administracao .table-dark td {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.2);
    }
    #administracao .table-dark tbody tr:nth-of-type(odd) {
        background-color: rgba(255, 255, 255, 0.1);
    }
    /* Explicitly set text color for inputs in administration tab */
    #administracao .form-control,
    #administracao textarea.form-control {
        background-color: rgba(255, 255, 255, 0.2);
        color: white !important; /* Ensure text is always white */
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    #administracao .form-control::placeholder {
        color: rgba(255, 255, 255, 0.7) !important; /* Ensure placeholder is visible */
    }
    #administracao .form-control:focus {
        background-color: rgba(255, 255, 255, 0.3);
        border-color: #007bff;
        box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
    }
    #administracao .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }
    #administracao .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }

    /* Adjusted button colors for admin section to ensure visibility on dark background */
    #administracao .btn-secondary {
        background-color: #6c757d; /* Darker secondary for dark background */
        border-color: #6c757d;
        color: #fff;
    }
    #administracao .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
    }

    #administracao .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    #administracao .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }
    #administracao .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }
    #administracao .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }
    #administracao .btn-info {
        background-color: #17a2b8;
        border-color: #17a2b8;
    }
    #administracao .btn-info:hover {
        background-color: #138496;
        border-color: #117a8b;
    }

    /* Adjust the new "Excluir todos" button */
    .btn-danger-lg {
        background-color: #dc3545;
        border-color: #dc3545;
        font-size: 1.25rem;
        padding: 0.8rem 1.5rem;
        width: 100%;
        max-width: 300px;
        margin-top: 20px;
    }
    .btn-danger-lg:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }


    /* Ajustes para telas menores */
    @media (max-width: 576px) {
        .container:not(#mainMenu) { /* Aplica-se apenas aos outros containers */
            padding: 10px;
        }
        h2, h3 {
            font-size: 1.5rem; /* Reduz o tamanho da fonte dos títulos */
        }
        .btn-lg {
            font-size: 1rem; /* Reduz o tamanho da fonte dos botões */
            padding: 0.75rem 1rem;
        }
        .row .col-12 {
            margin-bottom: 10px; /* Adiciona espaçamento entre as colunas empilhadas */
        }
    }
  </style>
</head>
<body>
  <div class="container text-center" id="mainMenu">
    <h2 class="mb-4">Bem vindo(a) a calculadora de taxas Workcell,<br>O que você quer fazer?</h2>
    <div class="d-grid gap-2">
      <button class="btn btn-primary btn-lg" onclick="openSection('fecharVenda')">Fechar uma venda</button>
      <button class="btn btn-dark btn-lg" onclick="openSection('repassarValores')">Repassar valores</button>
      <button class="btn btn-info btn-lg" onclick="openSection('calcularPorAparelho')">Calcular por aparelho</button>
      <button class="btn btn-secondary btn-lg" onclick="openSection('administracao')">Administração de Produtos</button> <!-- NEW BUTTON -->
    </div>
  </div>

  <div class="container hidden" id="fecharVenda">
    <h3 class="mb-4">Taxas de Maquininha e Fechamento de Venda</h3>
    <div class="row mb-3 w-100 justify-content-center"> <!-- Adicionado w-100 e justify-content-center -->
      <div class="col-12 col-md-4 mb-3"> <!-- Colunas responsivas -->
        <label>Maquininha</label>
        <select class="form-select" id="machine1" onchange="updateInstallmentsOptions(); updateTheme(this.value); autoCalculateFecharVenda()">
          <option value="pagbank">PagBank</option>
          <option value="infinity">InfinityPay</option>
          <option value="valorante">Valorante</option>
        </select>
      </div>
      <div class="col-12 col-md-4 mb-3" id="brand1Container">
        <label>Bandeira</label>
        <select class="form-select" id="brand1" onchange="autoCalculateFecharVenda()">
          <option value="visa">Visa / Master</option>
          <option value="hiper">Hipercard</option>
          <option value="elo">Elo</option>
          <option value="amex">Amex</option>
        </select>
      </div>
      <div class="col-12 col-md-4 mb-3">
        <label>Parcelas</label>
        <select class="form-select" id="installments1" onchange="autoCalculateFecharVenda()"></select>
      </div>
    </div>

    <div class="mb-3 d-flex justify-content-center flex-wrap"> <!-- Flexbox para centralizar e quebrar linha -->
      <label class="me-3"><input type="radio" name="modeFechar" value="total" checked onchange="toggleFecharVendaMode()" /> Valor total da venda</label>
      <label><input type="radio" name="modeFechar" value="parcela" onchange="toggleFecharVendaMode()" /> Modo parcelas</label>
    </div>

    <div id="fecharVendaInputs" class="w-100 d-flex justify-content-center"></div>
    <div id="resultFecharVenda" class="w-100 d-flex justify-content-center"></div>
    <button class="btn btn-outline-secondary mt-4" onclick="openSection('mainMenu', true)">Voltar</button>
  </div>

  <div class="container hidden" id="repassarValores">
    <h3 class="mb-4">Simulação para Clientes</h3>
    <div class="row mb-3 w-100 justify-content-center">
      <div class="col-12 col-md-6 mb-3">
        <label>Maquininha</label>
        <select class="form-select" id="machine2" onchange="updateTheme(this.value); updateBrandVisibility(); calculateRepassarValores()">
          <option value="pagbank">PagBank</option>
          <option value="infinity">InfinityPay</option>
          <option value="valorante">Valorante</option>
        </select>
      </div>
      <div class="col-12 col-md-6 mb-3" id="brand2Container">
        <label>Bandeira</label>
        <select class="form-select" id="brand2" onchange="calculateRepassarValores()">
          <option value="visa">Visa / Master</option>
          <option value="hiper">Hipercard</option>
          <option value="elo">Elo</option>
          <option value="amex">Amex</option>
        </select>
      </div>
    </div>

    <input type="number" step="0.01" min="0" id="repassarValue" class="form-control form-control-lg mb-3 w-100" style="max-width: 400px;" placeholder="Digite o valor desejado (líquido)" oninput="calculateRepassarValores()" />
    <div id="resultRepassarValores" class="w-100 d-flex flex-column align-items-center"></div>
    <button class="btn btn-outline-secondary mt-4" onclick="openSection('mainMenu', true)">Voltar</button>
  </div>

  <!-- Aba Calcular por Aparelho -->
  <div class="container hidden" id="calcularPorAparelho">
    <h3 class="mb-4">Calcular por Aparelho</h3>

    <div class="mb-3 w-100" style="max-width: 400px;">
        <label for="aparelhoSearch" class="form-label">Pesquisar Aparelho</label>
        <input type="text" class="form-control" id="aparelhoSearch" placeholder="Digite o nome do aparelho" oninput="filterAparelhos()">
    </div>

    <div class="row mb-3 w-100 justify-content-center">
      <div class="col-12 col-md-8">
        <label>Aparelho</label>
        <select class="form-select" id="aparelhoSelect" onchange="selectAparelhoAndCalculate()">
          <option value="">Selecione um aparelho</option>
        </select>
      </div>
    </div>

    <div class="row mb-3 w-100 justify-content-center">
        <div class="col-12 col-md-6 mb-3">
            <label>Maquininha</label>
            <select class="form-select" id="machine3" onchange="updateBrandVisibilityAparelho(); calculateAparelho()">
                <option value="pagbank">PagBank</option>
                <option value="infinity">InfinityPay</option>
                <option value="valorante">Valorante</option>
            </select>
        </div>
        <div class="col-12 col-md-6 mb-3" id="brand3Container">
            <label>Bandeira</label>
            <select class="form-select" id="brand3" onchange="calculateAparelho()">
                <option value="visa">Visa / Master</option>
                <option value="hiper">Hipercard</option>
                <option value="elo">Elo</option>
                <option value="amex">Amex</option>
            </select>
        </div>
    </div>

    <div id="resultCalcularPorAparelho" class="w-100 d-flex flex-column align-items-center"></div>
    <button class="btn btn-outline-secondary mt-4" onclick="openSection('mainMenu', true)">Voltar</button>
  </div>

  <!-- NEW SECTION: Administração de Produtos -->
  <div class="container hidden" id="administracao">
    <h3 class="mb-4">Administração de Produtos</h3>

    <div class="mb-4 text-start">
        <h4 class="text-white mb-3">Importar Produtos</h4>
        <div class="mb-3">
            <label for="pasteInput" class="form-label">Colar Lista (Ex: iPhone 14 - 3999.00):</label>
            <textarea class="form-control" id="pasteInput" rows="5" placeholder="Cole sua lista de produtos aqui, um por linha."></textarea>
        </div>
        <button class="btn btn-primary mb-3 me-2" onclick="importFromPaste()">Importar Colados</button>
        <button class="btn btn-secondary mb-3" onclick="document.getElementById('fileInput').click()">Upload de Arquivo (.txt/.csv)</button>
        <input type="file" id="fileInput" accept=".txt,.csv" class="d-none" onchange="importFromFile()">
        <div id="importStatus" class="mt-2"></div>
    </div>

    <div class="mb-4 text-start">
        <h4 class="text-white mb-3">Pesquisar Produtos</h4>
        <div class="mb-3">
            <input type="text" class="form-control" id="adminSearchInput" placeholder="Digite o nome do produto para pesquisar..." oninput="filterAdminProducts()">
        </div>
    </div>

    <!-- Comando Rápido Input - Título alterado aqui -->
    <div class="mb-4 text-start">
        <h4 class="text-white mb-3">Comando Rápido (IA*)</h4>
        <div class="input-group">
            <input type="text" class="form-control" id="naturalCommandInput" placeholder="Ex: baixar valor iPhone 13 para 3399" />
            <button class="btn btn-primary" onclick="processNaturalLanguageCommand()">Aplicar Comando</button>
        </div>
        <div id="commandStatus" class="mt-2"></div>
    </div>
    <!-- END Comando Rápido Input -->

    <div class="mb-4 text-start">
        <h4 class="text-white mb-3">Produtos Cadastrados</h4>
        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover">
                <thead>
                    <tr>
                        <th>Nome do Produto</th>
                        <th>Valor</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    <!-- Products will be loaded here -->
                </tbody>
            </table>
        </div>
        <button class="btn btn-success mt-3" onclick="addNewProductRow()">Adicionar Novo Produto</button>
    </div>

    <div class="mb-4 text-start">
        <h4 class="text-white mb-3">Exportar Produtos</h4>
        <button class="btn btn-info me-2" onclick="exportProducts('txt')">Exportar como TXT</button>
        <button class="btn btn-info" onclick="exportProducts('json')">Exportar como JSON</button>
    </div>

    <div class="mb-4 text-start">
        <button class="btn btn-danger-lg" onclick="deleteAllProducts()">Excluir todos os produtos</button>
    </div>


    <button class="btn btn-outline-secondary mt-4" onclick="openSection('mainMenu', true)">Voltar</button>
  </div>
  <!-- END NEW SECTION -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // A chave do localStorage para os produtos salvos
    const STORAGE_KEY = 'produtosSalvos';
    let products = []; // Array para armazenar os produtos da administração e da calculadora

    // Armazena o valor do aparelho selecionado para cálculo.
    // É importante que este valor seja atualizado sempre que um aparelho for selecionado
    // ou quando a lista de produtos for carregada/filtrada.
    let selectedAparelhoValue = 0; 

    const rates = {
      pagbank: {
        debito: 0.99,
        credito: [2.99, 4.09, 4.78, 5.47, 6.14, 6.81, 7.67, 8.33, 8.98, 9.63, 10.26, 10.90, 12.32, 12.94, 13.56, 14.17, 14.77, 15.37]
      },
      infinity: {
        visa: {
          debito: 0.75,
          credito: [2.69, 3.94, 4.46, 4.98, 5.49, 5.99, 6.51, 6.99, 7.51, 7.99, 8.49, 8.99]
        },
        hiper: { // Este conjunto de taxas será usado para Hipercard, Amex, Elo, Hiper
          debito: 1.88,
          credito: [4.46, 5.81, 6.32, 6.83, 7.33, 7.83, 8.34, 8.83, 9.32, 9.81, 10.29, 10.77]
        }
      },
      valorante: {
        visa: {
          debito: 0.95,
          credito: [3.45, 4.73, 5.47, 6.08, 6.57, 7.45, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 11.96, 12.64, 13.32, 14.00, 14.68, 15.36, 16.04, 16.72, 17.40]
        },
        mastercard: {
          debito: 0.95,
          credito: [3.45, 4.73, 5.47, 6.08, 6.57, 7.45, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 11.96, 12.64, 13.32, 14.00, 14.68, 15.36, 16.04, 16.72, 17.40]
        },
        elo: {
          debito: 1.69,
          credito: [3.65, 5.43, 6.11, 6.70, 7.17, 8.15, 9.13, 9.81, 11.17, 11.85, 12.53, 12.66, 13.39, 14.57, 15.25, 15.93, 16.61, 17.23, 17.97, 18.65] // CORRIGIDO: 10x de 11.15 para 11.17
        },
        hipercard: {
          debito: 0.95, // Manter este padrão já que não foi fornecida taxa específica de débito na tabela.
          credito: [3.95, 4.93, 5.61, 6.22, 6.71, 7.65, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 12.51, 13.19, 13.87, 14.55, 15.23, 15.91, 16.53, 17.21, 17.95]
        },
        amex: {
          debito: 0.95, // Manter este padrão já que não foi fornecida taxa específica de débito na tabela.
          credito: [3.95, 4.93, 5.61, 6.22, 6.71, 7.65, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 12.51, 13.19, 13.87, 14.55, 15.23, 15.91, 16.53, 17.21, 17.95]
        }
      }
    };

    let currentSectionId = 'mainMenu'; // Track the currently active section

    /**
     * Utility function to normalize strings (convert to lowercase, remove accents, and remove symbols).
     * @param {string} str - The string to be normalized.
     * @returns {string} The normalized string.
     */
    const normalizeString = str => str
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "") // remove acentos
      .replace(/[^a-z0-9\s]/gi, "");   // remove símbolos

    /**
     * Main function to switch between sections.
     * @param {string} sectionId - The ID of the section to open.
     * @param {boolean} [fromHistory=false] - True if called from browser history API.
     */
    function openSection(sectionId, fromHistory = false) {
        // Esconder todas as seções
        document.getElementById("mainMenu").classList.add("hidden");
        document.getElementById("fecharVenda").classList.add("hidden");
        document.getElementById("repassarValores").classList.add("hidden");
        document.getElementById("calcularPorAparelho").classList.add("hidden");
        document.getElementById("administracao").classList.add("hidden");

        // Mostrar a seção desejada
        document.getElementById(sectionId).classList.remove("hidden");
        currentSectionId = sectionId; // Atualizar a seção atual

        // Gerenciar a classe do body para os temas
        if (sectionId === 'mainMenu') {
            document.body.className = ''; // Limpa a classe do body para o menu principal (para o gradiente do mainMenu aparecer)
        } else if (sectionId === 'administracao') {
            document.body.className = 'infinity'; // Força o tema escuro para a administração
        } else {
            // Para as outras seções, aplica o tema da maquininha selecionada na respectiva seção
            let machineSelectId = '';
            if (sectionId === 'fecharVenda') machineSelectId = 'machine1';
            else if (sectionId === 'repassarValores') machineSelectId = 'machine2';
            else if (sectionId === 'calcularPorAparelho') machineSelectId = 'machine3';
            
            if (machineSelectId) {
                updateTheme(document.getElementById(machineSelectId).value);
            }
        }

        // Se não for uma navegação do histórico (botão voltar/avançar), adicionar ao histórico
        if (!fromHistory) {
            history.pushState({ sectionId: sectionId }, '', `#${sectionId}`);
        }
        
        // Executa funções de inicialização específicas para cada seção
        if (sectionId === 'fecharVenda') {
            updateInstallmentsOptions();
            updateBrandVisibility();
            toggleFecharVendaMode();
            autoCalculateFecharVenda();
        } else if (sectionId === 'repassarValores') {
            updateBrandVisibility();
            calculateRepassarValores();
        } else if (sectionId === 'calcularPorAparelho') {
            document.getElementById('aparelhoSearch').value = '';
            loadProductsFromLocalStorage();
            populateAparelhoSelect(products);
            updateBrandVisibilityAparelho();
        } else if (sectionId === 'administracao') {
            loadProductsFromLocalStorage();
            document.getElementById('adminSearchInput').value = '';
            document.getElementById('naturalCommandInput').value = '';
            renderAdminTable();
        }
    }

    // A função updateTheme agora só é chamada para aplicar os temas das maquininhas
    function updateTheme(machine) {
      document.body.className = machine;
    }

    function updateInstallmentsOptions() {
      const machine = document.getElementById("machine1").value;
      const installments = document.getElementById("installments1");
      installments.innerHTML = '<option value="0">Débito</option>'; // Always add debit option
      let max = 0;
      if(machine === "pagbank") max = 18;
      else if(machine === "infinity") max = 12;
      else if(machine === "valorante") max = 21;

      for (let i = 1; i <= max; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${i}x`;
        installments.appendChild(opt);
      }
    }

    function updateBrandVisibility() {
      const machine1 = document.getElementById("machine1").value;
      const machine2 = document.getElementById("machine2").value;
      
      // Controla a visibilidade da bandeira para a seção "Fechar uma venda"
      document.getElementById("brand1Container").style.display = 
          (machine1 === "infinity" || machine1 === "valorante") ? "block" : "none";
      
      // Controla a visibilidade da bandeira para a seção "Repassar valores"
      document.getElementById("brand2Container").style.display = 
          (machine2 === "infinity" || machine2 === "valorante") ? "block" : "none";
    }

    function updateBrandVisibilityAparelho() {
        const machine3 = document.getElementById("machine3").value;
        document.getElementById("brand3Container").style.display = 
            (machine3 === "infinity" || machine3 === "valorante") ? "block" : "none";
        calculateAparelho(); // Recalcula quando a máquina muda
    }

    function toggleFecharVendaMode() {
      const mode = document.querySelector('input[name="modeFechar"]:checked').value;
      const fecharVendaInputs = document.getElementById("fecharVendaInputs");
      fecharVendaInputs.innerHTML = "";
      if (mode === "total") {
        fecharVendaInputs.innerHTML = `<input type="number" step="0.01" min="0" id="fecharVendaValue" class="form-control form-control-lg mb-3" placeholder="Digite o valor total da venda" oninput="autoCalculateFecharVenda()" style="max-width: 400px;"/>`;
      } else {
        fecharVendaInputs.innerHTML = `
          <input type="number" step="0.01" min="0" id="fecharVendaValueParcela" class="form-control form-control-lg mb-3" placeholder="Digite o valor da parcela" oninput="autoCalculateFecharVenda()" style="max-width: 400px;"/>
        `;
      }
      autoCalculateFecharVenda(); // Dispara o cálculo após mudar o modo
    }

    function autoCalculateFecharVenda() {
      // Pequeno atraso para garantir que o DOM esteja atualizado após oninput
      setTimeout(calculateFecharVenda, 50); 
    }

    function calculateFecharVenda() {
      const machine = document.getElementById("machine1").value;
      const brand = document.getElementById("brand1").value || "visa";
      const mode = document.querySelector('input[name="modeFechar"]:checked').value;
      const installments = parseInt(document.getElementById("installments1").value);
      let value;

      if (mode === "total") {
        value = parseFloat(document.getElementById("fecharVendaValue")?.value);
      } else {
        const parcela = parseFloat(document.getElementById("fecharVendaValueParcela")?.value);
        if (isNaN(parcela) || parcela <= 0) {
          document.getElementById("resultFecharVenda").innerHTML = "";
          return;
        }
        value = parcela * (installments === 0 ? 1 : installments);
      }

      if (isNaN(value) || value <= 0) {
        document.getElementById("resultFecharVenda").innerHTML = "";
        return;
      }

      let tax = 0;
      if (machine === "pagbank") {
        tax = installments === 0 ? rates.pagbank.debito : rates.pagbank.credito[installments - 1];
      } else if (machine === "infinity") {
        // CORRIGIDO: Lógica para InfinityPay para agrupar bandeiras corretamente
        let infinityBrandActual = brand;
        if (infinityBrandActual === 'hiper' || infinityBrandActual === 'elo' || infinityBrandActual === 'amex') {
          infinityBrandActual = 'hiper'; // Agrupa essas bandeiras sob as taxas 'hiper'
        } else {
          infinityBrandActual = 'visa'; // Assume outras como visa/master
        }
        tax = installments === 0 ? rates.infinity[infinityBrandActual].debito : rates.infinity[infinityBrandActual].credito[installments - 1];
      } else if (machine === "valorante") {
        let actualBrand = brand.toLowerCase();
        // Mapeamento de bandeiras para Valorante se necessário (já estava ok)
        if (actualBrand === 'hiper') {
          actualBrand = 'hipercard';
        } else if (actualBrand === 'master') { 
          actualBrand = 'mastercard';
        }
        // Fallback para Visa se a bandeira não for encontrada nas taxas da Valorante (mantido para robustez)
        tax = installments === 0 ? (rates.valorante[actualBrand]?.debito ?? rates.valorante.visa.debito) : (rates.valorante[actualBrand]?.credito[installments - 1] ?? rates.valorante.visa.credito[installments - 1]);
      }

      const liquid = value * (1 - tax / 100);
      document.getElementById("resultFecharVenda").innerHTML = `
        <div class="alert alert-success fs-5 w-100" style="max-width: 400px;">
          <strong>Valor Líquido: </strong>R$ ${liquid.toFixed(2)} <br/>
          Taxa aplicada: ${tax.toFixed(2)}% (${installments === 0 ? "Débito" : `${installments}x`})
        </div>`;
    }

    function calculateRepassarValores() {
      const valorDesejado = parseFloat(document.getElementById("repassarValue").value);
      if (isNaN(valorDesejado) || valorDesejado <= 0) {
        document.getElementById("resultRepassarValores").innerHTML = "";
        return;
      }

      const machine = document.getElementById("machine2").value;
      const brand = document.getElementById("brand2").value || "visa";

      let maxInstallments = 0;
      if (machine === "pagbank") maxInstallments = 18;
      else if (machine === "infinity") maxInstallments = 12;
      else if (machine === "valorante") maxInstallments = 21;

      let resultHtml = "";

      let actualBrandForRates = brand.toLowerCase();
      if (machine === 'valorante') {
        if (actualBrandForRates === 'hiper') {
          actualBrandForRates = 'hipercard';
        } else if (actualBrandForRates === 'master') {
            actualBrandForRates = 'mastercard';
        }
      } else if (machine === 'infinity') {
          // CORRIGIDO: Lógica para InfinityPay para agrupar bandeiras corretamente
          if (actualBrandForRates === 'hiper' || actualBrandForRates === 'elo' || actualBrandForRates === 'amex') {
            actualBrandForRates = 'hiper';
          } else {
            actualBrandForRates = 'visa'; // Default para outras é visa (Mastercard, Visa)
          }
      }


      // Calcular para Débito
      let debitTax = 0;
      if (machine === "pagbank") {
          debitTax = rates.pagbank.debito;
      } else if (machine === "infinity") {
          debitTax = rates.infinity[actualBrandForRates]?.debito;
      } else if (machine === "valorante") {
          debitTax = rates.valorante[actualBrandForRates]?.debito ?? rates.valorante.visa.debito;
      }
      const valorBrutoDebit = valorDesejado / (1 - debitTax / 100);
      resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">Débito: R$ ${valorBrutoDebit.toFixed(2)} (${debitTax.toFixed(2)}%)</div>`;

      // Calcular para Parcelas de Crédito
      for (let i = 1; i <= maxInstallments; i++) {
        let creditTax = 0;
        if (machine === "pagbank") {
            creditTax = rates.pagbank.credito[i - 1];
        } else if (machine === "infinity") {
            creditTax = rates.infinity[actualBrandForRates]?.credito[i - 1];
        } else if (machine === "valorante") {
            creditTax = rates.valorante[actualBrandForRates]?.credito[i - 1] ?? rates.valorante.visa.credito[i - 1];
        }

        const valorBrutoCredit = valorDesejado / (1 - creditTax / 100);
        const valorParcela = valorBrutoCredit / i;
        resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">${i}x de R$ ${valorParcela.toFixed(2)} (Total: R$ ${valorBrutoCredit.toFixed(2)} )</div>`;
      }
      document.getElementById("resultRepassarValores").innerHTML = resultHtml;
      updateTheme(machine);
    }

    // --- Funções de Gerenciamento de Produtos (localStorage) ---
    function loadProductsFromLocalStorage() {
        try {
            const storedProducts = localStorage.getItem(STORAGE_KEY);
            if (storedProducts) {
                products = JSON.parse(storedProducts);
                console.log('Products loaded from localStorage:', products);
            } else {
                products = [];
                console.log('No products found in localStorage. Starting with empty list.');
            }
        } catch (e) {
            console.error('Error loading products from localStorage:', e);
            displayStatusAdmin('Error loading products. Clearing data. Please try again.', 'danger');
        }
    }

    function saveProductsToLocalStorage() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
            console.log('Products saved to localStorage.');
            displayStatusAdmin('Products saved successfully!', 'success');
        } catch (e) {
            console.error('Error saving products to localStorage:', e);
            displayStatusAdmin('Error saving products. Check browser storage space.', 'danger');
        }
    }

    // --- Renderização da Tabela de Administração ---
    // Added an optional 'filteredList' parameter to allow rendering filtered products
    function renderAdminTable(filteredList = products) {
        const tableBody = document.getElementById('productsTableBody');
        tableBody.innerHTML = ''; // Limpa a tabela existente

        if (filteredList.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center">No products registered or found.</td></tr>';
            return;
        }

        filteredList.forEach((product, index) => {
            // Find the original index of the product in the 'products' array
            const originalIndex = products.findIndex(p => p === product);
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td><input type="text" class="form-control" value="${escapeHtml(product.nome)}" onchange="editProduct(${originalIndex}, 'nome', this.value)"></td>
                <td><input type="text" class="form-control" value="${product.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}" onchange="editProduct(${originalIndex}, 'valor', this.value)"></td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteProduct(${originalIndex})">Delete</button></td>
            `;
        });
    }

    // Helper function to escape HTML for input values
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function (m) { return map[m]; });
    }

    // --- Manipulação de Produtos na Tabela de Administração ---
    function addNewProductRow() {
        products.push({ nome: 'New Product', valor: 0.00 });
        renderAdminTable(); // Render all products
        saveProductsToLocalStorage();
        // Scroll to the new row
        const table = document.getElementById('productsTableBody');
        table.scrollTop = table.scrollHeight;
    }

    function deleteProduct(index) {
        if (confirm('Are you sure you want to delete this product?')) {
            products.splice(index, 1);
            filterAdminProducts(); // Re-render with current filter applied
            saveProductsToLocalStorage();
            // Re-populate the calculator select list if it's open, to reflect changes
            if (!document.getElementById('calcularPorAparelho').classList.contains('hidden')) {
                populateAparelhoSelect(products);
            }
        }
    }

    // --- ROBUST PARSING FUNCTION FOR BRAZILIAN CURRENCY ---
    /**
     * Parses a Brazilian currency string into a float.
     * Handles various formats like "R$ 3.399,00", "3399,00", "3.399", "3399".
     * A comma or dot is treated as a decimal separator ONLY if it's the last separator
     * and is followed by exactly two digits (cents). Otherwise, it's removed (thousands separator).
     * @param {string} valueString - The string representing the currency value.
     * @returns {number} The parsed float value.
     */
    function parseBrazilianCurrencyToFloat(valueString) {
        if (typeof valueString !== 'string') {
            valueString = String(valueString);
        }
        // Remove currency symbols, spaces
        let cleaned = valueString.replace(/R\$?|RS?|\$|\s/g, '').trim();

        // Check if the string ends with a comma or dot followed by exactly two digits (cents)
        // This regex ensures we only consider the LAST group of .XX or ,XX as potential cents
        const potentialDecimalMatch = cleaned.match(/([.,])(\d{2})$/);

        if (potentialDecimalMatch) {
            // A clear decimal part (cents) is found.
            // Remove all other thousands separators from the integer part
            let integerPart = cleaned.substring(0, cleaned.length - 3); // Get string before .XX or ,XX
            integerPart = integerPart.replace(/[,.]/g, ''); // Remove all thousands separators
            
            let decimalSeparator = potentialDecimalMatch[1]; // Get the actual decimal separator (comma or dot)
            let centsPart = potentialDecimalMatch[2];       // Get the two cents digits

            // Reconstruct the number with a standard decimal point
            cleaned = integerPart + '.' + centsPart;
        } else {
            // If no clear cents part, then all commas and dots are thousands separators, so remove them
            // This handles cases like "3,399" (user means 3399) or "1.234" (user means 1234).
            cleaned = cleaned.replace(/[,.]/g, '');
        }
        
        let parsed = parseFloat(cleaned);
        return isNaN(parsed) ? 0 : parsed; // Return 0 or handle error if parsing fails
    }


    function editProduct(index, field, newValue) {
        if (products[index]) {
            if (field === 'valor') {
                const parsedValue = parseBrazilianCurrencyToFloat(newValue);
                if (!isNaN(parsedValue)) {
                    products[index][field] = parsedValue;
                } else {
                    console.error('Invalid value entered for the price field:', newValue);
                    displayStatusAdmin('Error: Invalid value for the product. Please enter a valid number (e.g., 399,00 or 1.749,50).', 'danger');
                    return; 
                }
            } else {
                products[index][field] = newValue;
            }
            saveProductsToLocalStorage();
            filterAdminProducts(); // This will re-render the table with the currently applied filter
            if (!document.getElementById('calcularPorAparelho').classList.contains('hidden')) {
                populateAparelhoSelect(products);
            }
        }
    }

    /**
     * Filters products in the admin table based on keywords (case and accent insensitive).
     */
    function filterAdminProducts() {
        const searchTerm = document.getElementById('adminSearchInput').value;
        const normalizedSearchTerm = normalizeString(searchTerm);
        // Split by space and filter out empty strings in case of multiple spaces
        const keywords = normalizedSearchTerm.split(' ').filter(word => word.length > 0);

        const filtered = products.filter(product => {
            const normalizedProductName = normalizeString(product.nome);
            return keywords.every(keyword => normalizedProductName.includes(keyword));
        });
        renderAdminTable(filtered); // Render the filtered list
    }

    // --- Import Functions in Administration ---
    function importFromPaste() {
        const pasteInput = document.getElementById('pasteInput');
        const lines = pasteInput.value.split('\n').filter(line => line.trim() !== '');
        let importedCount = 0;

        lines.forEach(line => {
            // Regex to capture everything before the last number that looks like currency.
            // (\d+(?:[.,]\d{1,2})?) ensures that we capture numbers with or without decimals (1 or 2 places)
            const regex = /^(.*?)\s*[- ]*(?:R\$|RS|\$)?\s*(\d+(?:[.,]\d{1,2})?)$/i;
            const match = line.match(regex);

            if (match) {
                const name = match[1].trim();
                const value = parseBrazilianCurrencyToFloat(match[2]); // Use the robust parsing function

                if (name && !isNaN(value) && value >= 0) {
                    products.push({ nome: name, valor: value });
                    importedCount++;
                } else {
                    console.warn('Invalid product on line (empty name or invalid value):', line);
                }
            } else {
                console.warn('Could not parse line (invalid format or no recognizable value):', line);
            }
        });

        filterAdminProducts(); // Render with current filter after import
        saveProductsToLocalStorage();
        pasteInput.value = ''; // Clear the text area
        displayStatusAdmin(`Imported ${importedCount} products from pasted text.`, 'info');
    }

    function importFromFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) {
            displayStatusAdmin('No file selected.', 'warning');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target.result;
            const lines = content.split('\n').filter(line => line.trim() !== '');
            let importedCount = 0;

            lines.forEach(line => {
                // Same robust regex for file import
                const regex = /^(.*?)\s*[- ]*(?:R\$|RS|\$)?\s*(\d+(?:[.,]\d{1,2})?)$/i;
                const match = line.match(regex);

                if (match) {
                    const name = match[1].trim();
                    const value = parseBrazilianCurrencyToFloat(match[2]);

                    if (name && !isNaN(value) && value >= 0) {
                        products.push({ nome: name, valor: value });
                        importedCount++;
                    } else {
                        console.warn('Invalid product in file:', line);
                    }
                } else {
                    console.warn('Could not parse line from file (invalid format or no recognizable value):', line);
                }
            });
            filterAdminProducts(); // Render with current filter after import
            saveProductsToLocalStorage();
            displayStatusAdmin(`Imported ${importedCount} products from file "${file.name}".`, 'info');
            fileInput.value = ''; // Clear file input
            if (!document.getElementById('calcularPorAparelho').classList.contains('hidden')) {
                populateAparelhoSelect(products);
            }
        };
        reader.onerror = (e) => {
            console.error('Error reading file:', e);
            displayStatusAdmin('Error reading the file.', 'danger');
        };
        reader.readAsText(file);
    }

    // --- Export Functions in Administration ---
    function exportProducts(format) {
        let dataStr;
        let filename;
        let mimeType;

        if (format === 'txt') {
            dataStr = products.map(p => `${p.nome} - R$ ${p.valor.toFixed(2).replace('.', ',')}`).join('\n');
            filename = 'products.txt';
            mimeType = 'text/plain';
        } else if (format === 'json') {
            dataStr = JSON.stringify(products, null, 2); // Pretty print JSON
            filename = 'products.json';
            mimeType = 'application/json';
        } else {
            console.error('Invalid export format.');
            return;
        }

        const blob = new Blob([dataStr], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a); // Required for Firefox
        a.click();
        document.body.removeChild(a); // Clean up
        URL.revokeObjectURL(url);
        displayStatusAdmin(`Products exported as ${format.toUpperCase()}.`, 'success');
    }

    // --- Status/Message Functions for Administration ---
    function displayStatusAdmin(message, type) {
        const statusDiv = document.getElementById('importStatus');
        statusDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 5000); // Remove message after 5 seconds
    }

    // --- NEW FUNCTION: Display status for natural language command input
    function displayCommandStatus(message, type) {
        const statusDiv = document.getElementById('commandStatus');
        statusDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 5000); // Remove message after 5 seconds
    }

    // --- Function to process natural language command
    function processNaturalLanguageCommand() {
        const commandInput = document.getElementById('naturalCommandInput');
        const commandText = commandInput.value.trim();
        if (!commandText) {
            displayCommandStatus('Por favor, digite um comando.', 'warning');
            return;
        }

        // Regex para capturar o nome do produto e o valor.
        // Captura tudo antes do último número que se parece com uma moeda.
        const commandRegex = /^(.*?)(?:\s*(?:para|de|-)?\s*(?:R\$?|RS?|\$)?\s*)?([\d.,]+)$/i;
        const match = commandText.match(commandRegex);

        let productNamePart = '';
        let valueString = '';

        if (match) {
            productNamePart = match[1].trim();
            valueString = match[2]; // valueString is the raw matched value like "3.399,00"
        } else {
            displayCommandStatus('Formato de comando inválido. Tente "Nome do Produto para Valor" ou "Ação Nome do Produto Valor".', 'danger');
            return;
        }

        // Utiliza a função parseBrazilianCurrencyToFloat aprimorada
        const newValue = parseBrazilianCurrencyToFloat(valueString);
        
        if (isNaN(newValue) || newValue < 0) {
            displayCommandStatus('Valor inválido encontrado no comando.', 'danger');
            return;
        }

        // Clean up product name part by removing potential command verbs and noise words
        const ignoreWords = ['baixar', 'valor', 'preco', 'preço', 'atualizar', 'mudar', 'trocar', 'para', 'de', 'novo', 'usado', 'do'];
        
        // Normaliza a parte do nome do produto do comando e filtra as palavras irrelevantes
        let termosNome = normalizeString(productNamePart)
          .split(/\s+/) // Divide por um ou mais espaços
          .filter(word => word.length > 0 && !ignoreWords.includes(word)); // Remove vazios e palavras irrelevantes

        if (termosNome.length === 0) {
            displayCommandStatus('Não foi possível identificar o nome do produto no comando. Tente ser mais específico e use termos que descrevam o produto.', 'danger');
            return;
        }

        // Encontra produtos que contêm TODAS as palavras-chave normalizadas
        const matchingProducts = products.filter(p => {
            const nomeNormalizado = normalizeString(p.nome);
            return termosNome.every(palavra => nomeNormalizado.includes(palavra));
        });

        if (matchingProducts.length === 0) {
            displayCommandStatus(`Nenhum produto encontrado com os termos "${productNamePart}".`, 'warning');
            return;
        }

        // Para simplificar, se houver várias correspondências, pegue a primeira.
        // Um sistema mais avançado poderia pedir ao usuário para escolher.
        const targetProduct = matchingProducts[0];

        // Confirmação
        const oldPriceFormatted = targetProduct.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const newPriceFormatted = newValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        if (confirm(`Deseja atualizar o valor de "${targetProduct.nome}" de ${oldPriceFormatted} para ${newPriceFormatted}?`)) {
            targetProduct.valor = newValue;
            saveProductsToLocalStorage();
            filterAdminProducts(); // Re-render the table with current filter
            populateAparelhoSelect(products); // Update calculator dropdown
            displayCommandStatus(`Valor de "${targetProduct.nome}" atualizado para ${newPriceFormatted}.`, 'success');
            commandInput.value = ''; // Clear input after successful command
        } else {
            displayCommandStatus('Atualização cancelada.', 'info');
        }
    }

    // --- NEW FUNCTION: Delete all products with master password ---
    function deleteAllProducts() {
        const masterPassword = "excluir"; // Master password
        const enteredPassword = prompt("ATENÇÃO: Para excluir TODOS os produtos, digite a senha mestre:");

        if (enteredPassword === masterPassword) {
            localStorage.removeItem(STORAGE_KEY);
            products = []; // Clear the array in memory
            renderAdminTable(); // Re-render the empty table
            alert("Todos os produtos foram excluídos com sucesso!");
            // Optionally, reload the page to fully reset if needed, or just let the renderAdminTable handle it.
            // location.reload(); // Uncomment if a full page reload is desired
        } else if (enteredPassword !== null) { // User clicked cancel, prompt returns null
            alert("Senha incorreta. Os produtos não foram excluídos.");
        }
    }

    /**
     * Populates the device dropdown (in the "Calcular por Aparelho" tab) with the product list.
     * @param {Array<Object>} filteredProducts - The list of products to display (can be filtered).
     */
    function populateAparelhoSelect(filteredProducts = products) { // Now uses `products`
        const aparelhoSelect = document.getElementById('aparelhoSelect');
        aparelhoSelect.innerHTML = '<option value="">Selecione um aparelho</option>'; // Clear previous options

        if (filteredProducts.length === 0) {
            const noProductsOption = document.createElement('option');
            noProductsOption.value = "";
            noProductsOption.textContent = "Nenhum produto cadastrado. Adicione na aba 'Administração'.";
            aparelhoSelect.appendChild(noProductsOption);
            selectedAparelhoValue = 0;
            document.getElementById('resultCalcularPorAparelho').innerHTML = '<div class="alert alert-warning mt-3 w-100" style="max-width: 400px;">Nenhum produto cadastrado. Acesse a aba "Administração" para adicionar.</div>';
            return;
        }

        filteredProducts.forEach(p => {
            const option = document.createElement('option');
            option.value = p.valor;
            option.textContent = `${p.nome} - R$ ${p.valor.toFixed(2)}`;
            aparelhoSelect.appendChild(option);
        });

        // Select the first product by default if there are any
        if (filteredProducts.length > 0) {
            aparelhoSelect.value = filteredProducts[0].valor;
            selectedAparelhoValue = parseFloat(filteredProducts[0].valor);
            calculateAparelho();
        } else {
            selectedAparelhoValue = 0;
            document.getElementById('resultCalcularPorAparelho').innerHTML = '<div class="alert alert-warning mt-3 w-100" style="max-width: 400px;">Nenhum produto encontrado com o termo de busca.</div>';
        }
    }

    /**
     * Filters products in the "Calcular por Aparelho" tab based on keywords (case and accent insensitive).
     */
    function filterAparelhos() {
        const searchTerm = document.getElementById('aparelhoSearch').value;
        const normalizedSearchTerm = normalizeString(searchTerm);
        const keywords = normalizedSearchTerm.split(' ').filter(word => word.length > 0);

        const filtered = products.filter(product => {
            const normalizedProductName = normalizeString(product.nome);
            return keywords.every(keyword => normalizedProductName.includes(keyword));
        });
        populateAparelhoSelect(filtered); // Repopulate the select with filtered results
    }

    function selectAparelhoAndCalculate() {
        const aparelhoSelect = document.getElementById('aparelhoSelect');
        selectedAparelhoValue = parseFloat(aparelhoSelect.value);
        calculateAparelho();
    }

    function calculateAparelho() {
        const machine = document.getElementById("machine3").value;
        const brand = document.getElementById("brand3").value || "visa";
        const resultDiv = document.getElementById('resultCalcularPorAparelho');

        if (isNaN(selectedAparelhoValue) || selectedAparelhoValue <= 0) {
            resultDiv.innerHTML = '<div class="alert alert-warning mt-3 w-100" style="max-width: 400px;">Selecione um aparelho para calcular.</div>';
            return;
        }

        let maxInstallments = 0;
        if (machine === "pagbank") maxInstallments = 18;
        else if (machine === "infinity") maxInstallments = 12;
        else if (machine === "valorante") maxInstallments = 21;

        let resultHtml = `<h4 class="mt-4">Resultados para R$ ${selectedAparelhoValue.toFixed(2)}</h4>`;

        let actualBrandForRates = brand.toLowerCase();
        if (machine === 'valorante') {
          if (actualBrandForRates === 'hiper') {
            actualBrandForRates = 'hipercard';
          } else if (actualBrandForRates === 'master') {
              actualBrandForRates = 'mastercard';
          }
        } else if (machine === 'infinity') {
            // CORRIGIDO: Lógica para InfinityPay para agrupar bandeiras corretamente
            if (actualBrandForRates === 'hiper' || actualBrandForRates === 'elo' || actualBrandForRates === 'amex') {
              actualBrandForRates = 'hiper';
            } else {
              actualBrandForRates = 'visa'; // Default para outras é visa (Mastercard, Visa)
            }
        }


        // Calcular para Débito
        let debitTax = 0;
        if (machine === "pagbank") {
            debitTax = rates.pagbank.debito;
        } else if (machine === "infinity") {
            debitTax = rates.infinity[actualBrandForRates]?.debito;
        } else if (machine === "valorante") {
            debitTax = rates.valorante[actualBrandForRates]?.debito ?? rates.valorante.visa.debito;
        }
        const valorBrutoDebit = selectedAparelhoValue / (1 - debitTax / 100);
        resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">Débito: R$ ${valorBrutoDebit.toFixed(2)} (${debitTax.toFixed(2)}%)</div>`;

        // Calcular para Parcelas de Crédito
        for (let i = 1; i <= maxInstallments; i++) {
            let creditTax = 0;
            if (machine === "pagbank") {
                creditTax = rates.pagbank.credito[i - 1];
            } else if (machine === "infinity") {
                creditTax = rates.infinity[actualBrandForRates]?.credito[i - 1];
            } else if (machine === "valorante") {
                creditTax = rates.valorante[actualBrandForRates]?.credito[i - 1] ?? rates.valorante.visa.credito[i - 1];
            }

            const valorBrutoCredit = selectedAparelhoValue / (1 - creditTax / 100);
            const valorParcela = valorBrutoCredit / i;
            resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">${i}x de R$ ${valorParcela.toFixed(2)} (Total: R$ ${valorBrutoCredit.toFixed(2)} )</div>`;
        }
        resultDiv.innerHTML = resultHtml;
    }

    // Inicializa a visibilidade e o tema quando a página carrega
    document.addEventListener('DOMContentLoaded', () => {
        // Assegura que o menu principal esteja visível e as outras seções ocultas ao carregar
        document.getElementById("mainMenu").classList.remove("hidden");
        document.getElementById("fecharVenda").classList.add("hidden");
        document.getElementById("repassarValores").classList.add("hidden");
        document.getElementById("calcularPorAparelho").classList.add("hidden");
        document.getElementById("administracao").classList.add("hidden"); // Ensure admin is hidden on load

        // No carregamento inicial, limpe a classe do body para que o gradiente do mainMenu apareça
        document.body.className = '';

        // Push initial state for main menu so back button can return to it
        // Check if history state already exists to avoid pushing on browser reload
        if (history.state === null || history.state.sectionId !== 'mainMenu') {
            history.replaceState({ sectionId: 'mainMenu' }, '', '#mainMenu');
        }

        // Inicializa as opções da máquina e bandeira para as seções que as utilizam.
        // openSection('mainMenu') já faz o trabalho de inicialização de tema.
        updateInstallmentsOptions();
        updateBrandVisibility();
        updateBrandVisibilityAparelho();
        toggleFecharVendaMode();
    });

    // Handle browser back/forward buttons (Android back button uses this)
    window.addEventListener('popstate', (event) => {
        const targetSectionId = event.state ? event.state.sectionId : 'mainMenu';
        openSection(targetSectionId, true); // Pass true to indicate navigation from history
    });

  </script>
</body>
</html>


By Brendon v2.10 -17 Jun 
