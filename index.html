<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calcule Taxas By Brendon</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: linear-gradient(-45deg, #1e3c72, #2a5298, #4b0082, #000428);
      background-size: 400% 400%;
      animation: gradientMove 9s ease infinite;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
      overflow-x: hidden; /* Evita rolagem horizontal */
    }

    @keyframes gradientMove {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    body.pagbank {
      background: #fff8dc; /* Amarelo claro */
      color: #000;
    }

    body.infinity {
      background: #000; /* Preto */
      color: #fff;
    }

    body.valorante {
      background: #2f4f4f; /* Verde musgo escuro */
      color: #fff;
    }

    /* Garante que elementos com 'hidden' não ocupem espaço */
    .hidden {
      display: none !important; /* Adicionado !important para forçar */
    }
    select, input {
      border-radius: 15px !important;
    }
    .single-line {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.95rem; /* você pode ajustar esse tamanho conforme necessário */
    }
    /* Estilos para centralizar o conteúdo em telas pequenas */
    .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 40px); /* Ajusta para preencher a tela menos o padding */
        padding: 15px; /* Padding para evitar que o conteúdo cole nas bordas */
        max-width: 500px; /* Limita a largura máxima do container para melhor visualização */
        margin: auto; /* Centraliza o container */
    }
    .d-grid button {
        width: 100%; /* Botões ocupam 100% da largura em telas pequenas */
        max-width: 300px; /* Limite a largura máxima para botões em telas maiores */
        margin-bottom: 10px; /* Espaçamento entre os botões */
    }
    .form-select, .form-control {
        width: 100%;
        max-width: 400px; /* Limite a largura máxima dos inputs e selects */
    }
    .alert {
        width: 100%;
        max-width: 400px;
    }
    /* Ajustes para telas menores */
    @media (max-width: 576px) {
        .container {
            padding: 10px;
        }
        h2, h3 {
            font-size: 1.5rem; /* Reduz o tamanho da fonte dos títulos */
        }
        .btn-lg {
            font-size: 1rem; /* Reduz o tamanho da fonte dos botões */
            padding: 0.75rem 1rem;
        }
        .row .col-12 {
            margin-bottom: 10px; /* Adiciona espaçamento entre as colunas empilhadas */
        }
    }
  </style>
</head>
<body class="">
  <div class="container text-center" id="mainMenu">
    <h2 class="mb-4">Bem vindo(a) a calculadora de taxas Workcell,<br>O que você quer fazer?</h2>
    <div class="d-grid gap-2">
      <button class="btn btn-primary btn-lg" onclick="openSection('fecharVenda')">Fechar uma venda</button>
      <button class="btn btn-dark btn-lg" onclick="openSection('repassarValores')">Repassar valores</button>
      <button class="btn btn-info btn-lg" onclick="openSection('calcularPorAparelho')">Calcular por aparelho</button>
    </div>
  </div>

  <div class="container hidden" id="fecharVenda">
    <h3 class="mb-4">Taxas de Maquininha e Fechamento de Venda</h3>
    <div class="row mb-3 w-100 justify-content-center"> <!-- Adicionado w-100 e justify-content-center -->
      <div class="col-12 col-md-4 mb-3"> <!-- Colunas responsivas -->
        <label>Maquininha</label>
        <select class="form-select" id="machine1" onchange="updateInstallmentsOptions(); updateTheme(this.value); updateBrandVisibility(); autoCalculateFecharVenda()">
          <option value="pagbank">PagBank</option>
          <option value="infinity">InfinityPay</option>
          <option value="valorante">Valorante</option>
        </select>
      </div>
      <div class="col-12 col-md-4 mb-3" id="brand1Container">
        <label>Bandeira</label>
        <select class="form-select" id="brand1" onchange="autoCalculateFecharVenda()">
          <option value="visa">Visa / Master</option>
          <option value="hiper">Hipercard</option>
          <option value="elo">Elo</option>
          <option value="amex">Amex</option>
        </select>
      </div>
      <div class="col-12 col-md-4 mb-3">
        <label>Parcelas</label>
        <select class="form-select" id="installments1" onchange="autoCalculateFecharVenda()"></select>
      </div>
    </div>

    <div class="mb-3 d-flex justify-content-center flex-wrap"> <!-- Flexbox para centralizar e quebrar linha -->
      <label class="me-3"><input type="radio" name="modeFechar" value="total" checked onchange="toggleFecharVendaMode()" /> Valor total da venda</label>
      <label><input type="radio" name="modeFechar" value="parcela" onchange="toggleFecharVendaMode()" /> Modo parcelas</label>
    </div>

    <div id="fecharVendaInputs" class="w-100 d-flex justify-content-center"></div>
    <div id="resultFecharVenda" class="w-100 d-flex justify-content-center"></div>
    <button class="btn btn-outline-secondary mt-4" onclick="location.reload()">Voltar</button>
  </div>

  <div class="container hidden" id="repassarValores">
    <h3 class="mb-4">Simulação para Clientes</h3>
    <div class="row mb-3 w-100 justify-content-center">
      <div class="col-12 col-md-6 mb-3">
        <label>Maquininha</label>
        <select class="form-select" id="machine2" onchange="updateTheme(this.value); updateBrandVisibility(); calculateRepassarValores()">
          <option value="pagbank">PagBank</option>
          <option value="infinity">InfinityPay</option>
          <option value="valorante">Valorante</option>
        </select>
      </div>
      <div class="col-12 col-md-6 mb-3" id="brand2Container">
        <label>Bandeira</label>
        <select class="form-select" id="brand2" onchange="calculateRepassarValores()">
          <option value="visa">Visa / Master</option>
          <option value="hiper">Hipercard</option>
          <option value="elo">Elo</option>
          <option value="amex">Amex</option>
        </select>
      </div>
    </div>

    <input type="number" step="0.01" min="0" id="repassarValue" class="form-control form-control-lg mb-3 w-100" style="max-width: 400px;" placeholder="Digite o valor desejado (líquido)" oninput="calculateRepassarValores()" />
    <div id="resultRepassarValores" class="w-100 d-flex flex-column align-items-center"></div>
    <button class="btn btn-outline-secondary mt-4" onclick="location.reload()">Voltar</button>
  </div>

  <!-- Nova aba para calcular por aparelho -->
  <div class="container hidden" id="calcularPorAparelho">
    <h3 class="mb-4">Calcular por Aparelho</h3>

    <div class="mb-3 w-100" style="max-width: 400px;">
        <label for="pdfUpload" class="form-label">Carregar Catálogo de Produtos (PDF)</label>
        <input class="form-control" type="file" id="pdfUpload" accept=".pdf" onchange="handlePdfUpload()">
    </div>

    <div class="mb-3 w-100" style="max-width: 400px;">
        <label for="aparelhoSearch" class="form-label">Pesquisar Aparelho</label>
        <input type="text" id="aparelhoSearch" class="form-control" placeholder="Digite o nome do aparelho" oninput="filterAparelhos()">
    </div>

    <div class="row mb-3 w-100 justify-content-center">
      <div class="col-12 col-md-8">
        <label>Aparelho</label>
        <select class="form-select" id="aparelhoSelect" onchange="selectAparelhoAndCalculate()">
          <option value="">Selecione um aparelho</option>
        </select>
      </div>
    </div>

    <div class="row mb-3 w-100 justify-content-center">
        <div class="col-12 col-md-6 mb-3">
            <label>Maquininha</label>
            <select class="form-select" id="machine3" onchange="updateBrandVisibilityAparelho(); calculateAparelho()">
                <option value="pagbank">PagBank</option>
                <option value="infinity">InfinityPay</option>
                <option value="valorante">Valorante</option>
            </select>
        </div>
        <div class="col-12 col-md-6 mb-3" id="brand3Container">
            <label>Bandeira</label>
            <select class="form-select" id="brand3" onchange="calculateAparelho()">
                <option value="visa">Visa / Master</option>
                <option value="hiper">Hipercard</option>
                <option value="elo">Elo</option>
                <option value="amex">Amex</option>
            </select>
        </div>
    </div>

    <div id="resultCalcularPorAparelho" class="w-100 d-flex flex-column align-items-center"></div>
    <button class="btn btn-outline-secondary mt-4" onclick="location.reload()">Voltar</button>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Incluindo PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script>
    // Configura o worker do PDF.js (necessário para o funcionamento)
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

    let produtos = []; // Array para armazenar os produtos do PDF
    let selectedAparelhoValue = 0; // Armazena o valor do aparelho selecionado

    const rates = {
      pagbank: {
        debito: 0.99,
        credito: [2.99, 4.09, 4.78, 5.47, 6.14, 6.81, 7.67, 8.33, 8.98, 9.63, 10.26, 10.90, 12.32, 12.94, 13.56, 14.17, 14.77, 15.37]
      },
      infinity: {
        visa: {
          debito: 0.75,
          credito: [2.69, 3.94, 4.46, 4.98, 5.49, 5.99, 6.51, 6.99, 7.51, 7.99, 8.49, 8.99]
        },
        hiper: {
          debito: 1.88,
          credito: [4.46, 5.81, 6.32, 6.83, 7.33, 7.83, 8.34, 8.83, 9.32, 9.81, 10.29, 10.77]
        }
      },
      valorante: {
        visa: {
          debito: 0.95,
          credito: [3.45, 4.73, 5.47, 6.08, 6.57, 7.45, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 11.96, 12.64, 13.32, 14.00, 14.68, 15.36, 16.04, 16.72, 17.40]
        },
        mastercard: {
          debito: 0.95,
          credito: [3.45, 4.73, 5.47, 6.08, 6.57, 7.45, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 11.96, 12.64, 13.32, 14.00, 14.68, 15.36, 16.04, 16.72, 17.40]
        },
        elo: {
          debito: 1.69,
          credito: [3.65, 5.43, 6.11, 6.70, 7.17, 8.15, 9.13, 9.81, 10.49, 11.15, 11.85, 12.53, 12.66, 13.39, 14.57, 15.25, 15.93, 16.61, 17.23, 17.97, 18.65]
        },
        hipercard: {
          debito: 0.95,
          credito: [3.95, 4.93, 5.61, 6.22, 6.71, 7.65, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 12.51, 13.19, 13.87, 14.55, 15.23, 15.91, 16.53, 17.21, 17.95]
        },
        amex: {
          debito: 0.95,
          credito: [3.95, 4.93, 5.61, 6.22, 6.71, 7.65, 8.43, 9.11, 9.79, 10.47, 11.15, 11.83, 12.51, 13.19, 13.87, 14.55, 15.23, 15.91, 16.53, 17.21, 17.95]
        }
      }
    };

    // Função central para alternar as seções
    function openSection(sectionId) {
        // Oculta todas as seções primeiro
        document.getElementById("mainMenu").classList.add("hidden");
        document.getElementById("fecharVenda").classList.add("hidden");
        document.getElementById("repassarValores").classList.add("hidden");
        document.getElementById("calcularPorAparelho").classList.add("hidden");

        // Exibe a seção desejada
        document.getElementById(sectionId).classList.remove("hidden");

        // Executa funções de inicialização específicas para cada seção
        if (sectionId === 'fecharVenda') {
            updateInstallmentsOptions();
            toggleFecharVendaMode();
            updateBrandVisibility();
            updateTheme(document.getElementById("machine1").value); // Assegura o tema correto
            autoCalculateFecharVenda(); // Dispara cálculo inicial se houver valor
        } else if (sectionId === 'repassarValores') {
            updateTheme(document.getElementById("machine2").value);
            updateBrandVisibility();
            calculateRepassarValores(); // Garante que os valores sejam calculados ao abrir
        } else if (sectionId === 'calcularPorAparelho') {
            document.getElementById('aparelhoSearch').value = ''; // Limpa o campo de busca
            populateAparelhoSelect(produtos); // Preenche e filtra o dropdown com todos os produtos
            updateTheme(document.getElementById("machine3").value);
            updateBrandVisibilityAparelho();
        }
    }

    function updateTheme(machine) {
      document.body.className = machine;
    }

    function updateInstallmentsOptions() {
      const machine = document.getElementById("machine1").value;
      const installments = document.getElementById("installments1");
      installments.innerHTML = '<option value="0">Débito</option>'; // Always add debit option
      let max = 0;
      if(machine === "pagbank") max = 18;
      else if(machine === "infinity") max = 12;
      else if(machine === "valorante") max = 21;

      for (let i = 1; i <= max; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${i}x`;
        installments.appendChild(opt);
      }
    }

    function updateBrandVisibility() {
      const machine1 = document.getElementById("machine1").value;
      const machine2 = document.getElementById("machine2").value;
      
      // Controla a visibilidade da bandeira para a seção "Fechar uma venda"
      document.getElementById("brand1Container").style.display = 
          (machine1 === "infinity" || machine1 === "valorante") ? "block" : "none";
      
      // Controla a visibilidade da bandeira para a seção "Repassar valores"
      document.getElementById("brand2Container").style.display = 
          (machine2 === "infinity" || machine2 === "valorante") ? "block" : "none";
    }

    function updateBrandVisibilityAparelho() {
        const machine3 = document.getElementById("machine3").value;
        document.getElementById("brand3Container").style.display = 
            (machine3 === "infinity" || machine3 === "valorante") ? "block" : "none";
        calculateAparelho(); // Recalcula quando a máquina muda
    }

    function toggleFecharVendaMode() {
      const mode = document.querySelector('input[name="modeFechar"]:checked').value;
      const fecharVendaInputs = document.getElementById("fecharVendaInputs");
      fecharVendaInputs.innerHTML = "";
      if (mode === "total") {
        fecharVendaInputs.innerHTML = `<input type="number" step="0.01" min="0" id="fecharVendaValue" class="form-control form-control-lg mb-3" placeholder="Digite o valor total da venda" oninput="autoCalculateFecharVenda()" style="max-width: 400px;"/>`;
      } else {
        fecharVendaInputs.innerHTML = `
          <input type="number" step="0.01" min="0" id="fecharVendaValueParcela" class="form-control form-control-lg mb-3" placeholder="Digite o valor da parcela" oninput="autoCalculateFecharVenda()" style="max-width: 400px;"/>
        `;
      }
      autoCalculateFecharVenda(); // Dispara o cálculo após mudar o modo
    }

    function autoCalculateFecharVenda() {
      // Pequeno atraso para garantir que o DOM esteja atualizado após oninput
      setTimeout(calculateFecharVenda, 50); 
    }

    function calculateFecharVenda() {
      const machine = document.getElementById("machine1").value;
      const brand = document.getElementById("brand1").value || "visa";
      const mode = document.querySelector('input[name="modeFechar"]:checked').value;
      const installments = parseInt(document.getElementById("installments1").value);
      let value;

      if (mode === "total") {
        value = parseFloat(document.getElementById("fecharVendaValue")?.value);
      } else {
        const parcela = parseFloat(document.getElementById("fecharVendaValueParcela")?.value);
        if (isNaN(parcela) || parcela <= 0) {
          document.getElementById("resultFecharVenda").innerHTML = "";
          return;
        }
        value = parcela * (installments === 0 ? 1 : installments);
      }

      if (isNaN(value) || value <= 0) {
        document.getElementById("resultFecharVenda").innerHTML = "";
        return;
      }

      let tax = 0;
      if (machine === "pagbank") {
        tax = installments === 0 ? rates.pagbank.debito : rates.pagbank.credito[installments - 1];
      } else if (machine === "infinity") {
        // InfinityPay só tem taxas para Visa/Master e Hipercard. Outras bandeiras usam Visa/Master como fallback
        const infinityBrand = (brand === 'elo' || brand === 'amex') ? 'visa' : brand; 
        tax = installments === 0 ? rates.infinity[infinityBrand].debito : rates.infinity[infinityBrand].credito[installments - 1];
      } else if (machine === "valorante") {
        let actualBrand = brand.toLowerCase();
        // Mapeamento de bandeiras para Valorante se necessário
        if (actualBrand === 'hiper') {
          actualBrand = 'hipercard';
        } else if (actualBrand === 'master') { // Considerando que Visa/Master é uma opção
          actualBrand = 'mastercard'; // Ou 'visa', dependendo da sua preferência para as taxas
        }
        // Fallback para Visa se a bandeira não for encontrada nas taxas da Valorante
        tax = installments === 0 ? (rates.valorante[actualBrand]?.debito ?? rates.valorante.visa.debito) : (rates.valorante[actualBrand]?.credito[installments - 1] ?? rates.valorante.visa.credito[installments - 1]);
      }

      const liquid = value * (1 - tax / 100);
      document.getElementById("resultFecharVenda").innerHTML = `
        <div class="alert alert-success fs-5 w-100" style="max-width: 400px;">
          <strong>Valor Líquido: </strong>R$ ${liquid.toFixed(2)} <br/>
          Taxa aplicada: ${tax.toFixed(2)}% (${installments === 0 ? "Débito" : `${installments}x`})
        </div>`;
    }

    function calculateRepassarValores() {
      const valorDesejado = parseFloat(document.getElementById("repassarValue").value);
      if (isNaN(valorDesejado) || valorDesejado <= 0) {
        document.getElementById("resultRepassarValores").innerHTML = "";
        return;
      }

      const machine = document.getElementById("machine2").value;
      const brand = document.getElementById("brand2").value || "visa";

      let maxInstallments = 0;
      if (machine === "pagbank") maxInstallments = 18;
      else if (machine === "infinity") maxInstallments = 12;
      else if (machine === "valorante") maxInstallments = 21;

      let resultHtml = "";

      let actualBrandForRates = brand.toLowerCase();
      if (machine === 'valorante') {
        if (actualBrandForRates === 'hiper') {
          actualBrandForRates = 'hipercard';
        } else if (actualBrandForRates === 'master') {
            actualBrandForRates = 'mastercard';
        }
      } else if (machine === 'infinity') {
          // InfinityPay: Elo e Amex usam taxas da Visa
          if (actualBrandForRates === 'elo' || actualBrandForRates === 'amex') {
            actualBrandForRates = 'visa';
          }
      }


      // Calcular para Débito
      let debitTax = 0;
      if (machine === "pagbank") {
          debitTax = rates.pagbank.debito;
      } else if (machine === "infinity") {
          debitTax = rates.infinity[actualBrandForRates]?.debito ?? rates.infinity.visa.debito;
      } else if (machine === "valorante") {
          debitTax = rates.valorante[actualBrandForRates]?.debito ?? rates.valorante.visa.debito;
      }
      const valorBrutoDebit = valorDesejado / (1 - debitTax / 100);
      resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">Débito: R$ ${valorBrutoDebit.toFixed(2)} (${debitTax.toFixed(2)}%)</div>`;

      // Calcular para Parcelas de Crédito
      for (let i = 1; i <= maxInstallments; i++) {
        let creditTax = 0;
        if (machine === "pagbank") {
            creditTax = rates.pagbank.credito[i - 1];
        } else if (machine === "infinity") {
            creditTax = rates.infinity[actualBrandForRates]?.credito[i - 1] ?? rates.infinity.visa.credito[i - 1];
        } else if (machine === "valorante") {
            creditTax = rates.valorante[actualBrandForRates]?.credito[i - 1] ?? rates.valorante.visa.credito[i - 1];
        }

        const valorBrutoCredit = valorDesejado / (1 - creditTax / 100);
        const valorParcela = valorBrutoCredit / i;
        resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">${i}x de R$ ${valorParcela.toFixed(2)} (Total: R$ ${valorBrutoCredit.toFixed(2)} )</div>`;
      }
      document.getElementById("resultRepassarValores").innerHTML = resultHtml;
      updateTheme(machine);
    }

    /**
     * Tenta extrair produtos (nome e valor) do texto completo de um PDF
     * que se parece com um formato CSV com campos entre aspas.
     * @param {string} fullText - O texto completo extraído do PDF.
     * @returns {Array<Object>} Uma array de objetos { nome: string, valor: number }.
     */
    function parseFullTextForProducts(fullText) {
        const products = [];
        console.log("Iniciando parse do texto completo do PDF para produtos...");

        // Regex para encontrar cada linha de produto no formato CSV-like.
        // Captura o que está dentro da primeira aspas (nome do produto),
        // e o valor que vem após "R$ " e pode ter pontos/vírgulas, dentro da última aspas.
        // Usa `[^"]*` para "qualquer coisa que não seja aspas".
        // O `(?:(?!",R\$).)*` tenta ser mais preciso para ignorar campos intermediários até o R$.
        const productRegex = /"([^"]*)",(?:(?!",R\$).)*"R\$ ([\d\.,]+)"/g;
        // Explicação da Regex:
        // "([^"]*)"        -> Captura o que está dentro da primeira aspas (Group 1: Nome do Produto).
        // ,                -> A vírgula após o nome.
        // (?:(?!",R\$).)* -> Não captura, mas consome qualquer caractere `.`
        //                    desde que não seja seguido pela sequência `",R$` (lookahead negativo).
        //                    Isso ajuda a pular campos intermediários até o valor.
        // "R\$ "           -> Corresponde literalmente a "R$ " (escapando o $).
        // ([\d\.,]+)       -> Captura o valor numérico (Group 2: Valor). Pode ter dígitos, pontos e vírgulas.
        // "                -> Fecha a aspas do valor.

        let match;
        // Executa a regex repetidamente em todo o texto
        while ((match = productRegex.exec(fullText)) !== null) {
            const rawName = match[1];
            const rawValueStr = match[2];

            // Limpeza do Nome do Produto:
            // Remove quebras de linha e múltiplos espaços, e "sujeira" comum
            let cleanName = rawName.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
            // Remove termos que não fazem parte do nome, mas são metadados da tabela
            const irrelevantNameTerms = [
                "código", "uni. medida", "categoria", "tamanho", "cpf/cnpj", "endereço",
                "telefone", "workcell tecnologia", "n°", "cidade", "bairro", "catálogo de produtos",
                "inscrição estadual", "estado (uf)", "e-mail", "confira a nossa lista",
                "aproveite para fazer seus pedidos", "produto", "valor"
            ];
            for(const term of irrelevantNameTerms) {
                const regex = new RegExp(`\\b${term}\\b`, 'gi'); // `\\b` para word boundary, `gi` para global e case-insensitive
                cleanName = cleanName.replace(regex, '').trim();
            }

            // Limpeza do Valor:
            // Remove separadores de milhar (ponto) e troca vírgula por ponto para parseFloat
            let value = parseFloat(rawValueStr.replace(/\./g, '').replace(',', '.'));

            // Adiciona o produto se o nome e o valor forem válidos
            if (cleanName && !isNaN(value) && value > 0) {
                // Evita duplicatas, útil se o regex pegar o mesmo item em páginas diferentes
                if (!products.some(p => p.nome === cleanName && p.valor === value)) {
                    products.push({ nome: cleanName, valor: value });
                }
            } else {
                console.warn("Item não processado (nome ou valor inválido):", { rawName, rawValueStr, cleanName, value });
            }
        }
        console.log("Produtos encontrados pelo parse:", products);
        return products;
    }


    async function handlePdfUpload() {
        const fileInput = document.getElementById('pdfUpload');
        const aparelhoSelect = document.getElementById('aparelhoSelect');
        const resultDiv = document.getElementById('resultCalcularPorAparelho');

        // Limpa os produtos e resultados anteriores
        produtos = [];
        aparelhoSelect.innerHTML = '<option value="">Selecione um aparelho</option>';
        resultDiv.innerHTML = '';
        document.getElementById('aparelhoSearch').value = ''; // Limpa o campo de busca

        const file = fileInput.files[0];
        if (!file) {
            console.log("Nenhum arquivo selecionado.");
            return;
        }

        resultDiv.innerHTML = '<div class="alert alert-info mt-3 w-100" style="max-width: 400px;">Carregando e processando PDF... Isso pode levar um momento.</div>';
        console.log("Arquivo PDF selecionado:", file.name, "Tamanho:", file.size, "bytes");

        const reader = new FileReader();
        reader.onload = async function() {
            const typedarray = new Uint8Array(this.result);
            try {
                console.log("Tentando carregar documento PDF com pdfjsLib...");
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                console.log("Documento PDF carregado com sucesso. Número de páginas:", pdf.numPages);
                
                let fullTextContent = "";
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    // Juntamos os itens de texto sem espaços, para tentar preservar a estrutura original do "CSV"
                    fullTextContent += textContent.items.map(item => item.str).join(''); 
                    // Adicionar uma quebra de linha forte entre as páginas pode ajudar a separar registros
                    fullTextContent += '\n'; 
                }
                console.log("Conteúdo de texto completo do PDF.js (primeiros 1000 chars):", fullTextContent.substring(0, 1000) + "...");
                
                // Agora, use a nova função de parsing baseada em regex
                produtos = parseFullTextForProducts(fullTextContent);
                
                // Popula o select de aparelhos com os produtos extraídos
                populateAparelhoSelect(produtos); // Usa a função populadora padrão

                if (produtos.length === 0) {
                    resultDiv.innerHTML = '<div class="alert alert-warning mt-3 w-100" style="max-width: 400px;">Nenhum produto encontrado no PDF ou formato não reconhecido. Certifique-se de que o PDF contém texto selecionável em formato de tabela.</div>';
                    console.warn("Nenhum produto foi extraído. Verifique o console para logs detalhados da extração.");
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-success mt-3 w-100" style="max-width: 400px;">Catálogo carregado com sucesso! ' + produtos.length + ' produtos encontrados.</div>';
                    console.log("Catálogo carregado com sucesso! Produtos extraídos:", produtos);
                }

            } catch (error) {
                console.error("Erro ao processar PDF:", error);
                resultDiv.innerHTML = '<div class="alert alert-danger mt-3 w-100" style="max-width: 400px;">Erro ao carregar ou ler o PDF. Verifique o formato do arquivo e se é um PDF válido. Detalhes no console.</div>';
            }
        };
        reader.onerror = function(error) {
            console.error("Erro ao ler o arquivo FileReader:", error);
            resultDiv.innerHTML = '<div class="alert alert-danger mt-3 w-100" style="max-width: 400px;">Erro ao ler o arquivo selecionado. Tente novamente.</div>';
        };
        reader.readAsArrayBuffer(file);
    }

    /**
     * Popula o dropdown de aparelhos com uma lista de produtos.
     * @param {Array<Object>} filteredProducts - A lista de produtos a ser exibida (pode ser filtrada).
     */
    function populateAparelhoSelect(filteredProducts = produtos) {
        const aparelhoSelect = document.getElementById('aparelhoSelect');
        aparelhoSelect.innerHTML = '<option value="">Selecione um aparelho</option>'; // Limpa opções anteriores

        filteredProducts.forEach(p => {
            const option = document.createElement('option');
            option.value = p.valor;
            option.textContent = `${p.nome} - R$ ${p.valor.toFixed(2)}`;
            aparelhoSelect.appendChild(option);
        });

        // Se houver produtos filtrados, seleciona o primeiro para exibir os cálculos iniciais
        if (filteredProducts.length > 0) {
            aparelhoSelect.value = filteredProducts[0].valor;
            selectedAparelhoValue = filteredProducts[0].valor;
            calculateAparelho();
        } else {
            // Se não houver produtos após o filtro, limpa os resultados
            document.getElementById('resultCalcularPorAparelho').innerHTML = '<div class="alert alert-warning mt-3 w-100" style="max-width: 400px;">Nenhum produto encontrado com o termo de busca.</div>';
            selectedAparelhoValue = 0; // Reseta o valor selecionado
        }
    }

    // Filtra os aparelhos com base no termo de busca
    function filterAparelhos() {
        const searchTerm = document.getElementById('aparelhoSearch').value.toLowerCase();
        // Filtra a array 'produtos' original (que contém todos os produtos do PDF)
        const filtered = produtos.filter(p => p.nome.toLowerCase().includes(searchTerm));
        populateAparelhoSelect(filtered); // Repopula o select com os resultados filtrados
    }

    function selectAparelhoAndCalculate() {
        const aparelhoSelect = document.getElementById('aparelhoSelect');
        selectedAparelhoValue = parseFloat(aparelhoSelect.value);
        calculateAparelho();
    }

    function calculateAparelho() {
        const machine = document.getElementById("machine3").value;
        const brand = document.getElementById("brand3").value || "visa";
        const resultDiv = document.getElementById('resultCalcularPorAparelho');

        if (isNaN(selectedAparelhoValue) || selectedAparelhoValue <= 0) {
            resultDiv.innerHTML = '<div class="alert alert-warning mt-3 w-100" style="max-width: 400px;">Selecione um aparelho para calcular.</div>';
            return;
        }

        let maxInstallments = 0;
        if (machine === "pagbank") maxInstallments = 18;
        else if (machine === "infinity") maxInstallments = 12;
        else if (machine === "valorante") maxInstallments = 21;

        let resultHtml = `<h4 class="mt-4">Resultados para R$ ${selectedAparelhoValue.toFixed(2)}</h4>`;

        let actualBrandForRates = brand.toLowerCase();
        if (machine === 'valorante') {
            if (actualBrandForRates === 'hiper') {
                actualBrandForRates = 'hipercard';
            } else if (actualBrandForRates === 'master') {
                actualBrandForRates = 'mastercard';
            }
        } else if (machine === 'infinity') {
            if (actualBrandForRates === 'elo' || actualBrandForRates === 'amex') {
                actualBrandForRates = 'visa';
            }
        }

        // Calcular para Débito
        let debitTax = 0;
        if (machine === "pagbank") {
            debitTax = rates.pagbank.debito;
        } else if (machine === "infinity") {
            debitTax = rates.infinity[actualBrandForRates]?.debito ?? rates.infinity.visa.debito;
        } else if (machine === "valorante") {
            debitTax = rates.valorante[actualBrandForRates]?.debito ?? rates.valorante.visa.debito;
        }
        const valorBrutoDebit = selectedAparelhoValue / (1 - debitTax / 100);
        resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">Débito: R$ ${valorBrutoDebit.toFixed(2)} (${debitTax.toFixed(2)}%)</div>`;

        // Calcular para Parcelas de Crédito
        for (let i = 1; i <= maxInstallments; i++) {
            let creditTax = 0;
            if (machine === "pagbank") {
                creditTax = rates.pagbank.credito[i - 1];
            } else if (machine === "infinity") {
                creditTax = rates.infinity[actualBrandForRates]?.credito[i - 1] ?? rates.infinity.visa.credito[i - 1];
            } else if (machine === "valorante") {
                creditTax = rates.valorante[actualBrandForRates]?.credito[i - 1] ?? rates.valorante.visa.credito[i - 1];
            }

            const valorBrutoCredit = selectedAparelhoValue / (1 - creditTax / 100);
            const valorParcela = valorBrutoCredit / i;
            resultHtml += `<div class="alert alert-dark single-line w-100" style="max-width: 400px;">${i}x de R$ ${valorParcela.toFixed(2)} (Total: R$ ${valorBrutoCredit.toFixed(2)} )</div>`;
        }
        resultDiv.innerHTML = resultHtml;
    }

    // Inicializa a visibilidade e o tema quando a página carrega
    document.addEventListener('DOMContentLoaded', () => {
        // Assegura que o menu principal esteja visível e as outras seções ocultas ao carregar
        document.getElementById("mainMenu").classList.remove("hidden");
        document.getElementById("fecharVenda").classList.add("hidden");
        document.getElementById("repassarValores").classList.add("hidden");
        document.getElementById("calcularPorAparelho").classList.add("hidden");

        // Inicializa as opções da máquina e bandeira para todas as seções
        updateInstallmentsOptions();
        updateBrandVisibility();
        updateBrandVisibilityAparelho(); // Para a seção "Calcular por Aparelho" também
        updateTheme(document.getElementById("machine1").value); // Define o tema inicial com base na máquina 1
        toggleFecharVendaMode(); // Inicializa o modo de fechamento de venda
    });

  </script>
</body>
</html>